String.prototype.hashCode||(String.prototype.hashCode=function(){let e,t,r=0;if(0===this.length)return r;for(e=0;e<this.length;e++)t=this.charCodeAt(e),r=(r<<5)-r+t,r|=0;return r}),String.prototype.asSF=function(){let e=document.createElement("template");switch(e.insertAdjacentHTML("afterbegin",this),e.childElementCount){case 0:return null;case 1:return SF.asSF(e.firstChild);default:return SF.asSFarr(e.children)}};class SFKey{}SFKey.map=Symbol("SFNode map"),SFKey.key=Symbol("SFNode's key"),SFKey.templates=Symbol("SF template map"),SFKey.placeholder=Symbol("Placeholder function. Do nothing"),SFKey.isRoot=Symbol("If true, this.$ == root element"),SFKey.beforeSetHooks=Symbol("Before set hook list"),SFKey.afterSetHooks=Symbol("After set hook list"),SFKey.beforeDelHooks=Symbol("Before delete hook list"),SFKey.afterDelHooks=Symbol("After delete hook list"),Object.freeze(SFKey);class SF{static build(e){e||(e=document.querySelector("[sf]")),e[SFKey.isRoot]=!0;let t=this.asSF(e);return t.newTemplate=function(e,t){let r=new Proxy(SF[SFKey.placeholder],{apply:function(e,r,o){let a=t().asSF();return 1==o.length?o[0](a):o.length>1&&o[0](a,...o.slice(1)),a}});return SF[SFKey.templates][e]=r,r},t.asTemplate=function(e,t){return this.newTemplate(e,()=>t.outerHTML)},t}static asSF(e){if(!e)return e;if(e[SFKey.key]&&SF[SFKey.map][e[SFKey.key]])return SF[SFKey.map][e[SFKey.key]];e[SFKey.key]=`${(new Date).getTime()}__${Math.random()}`.replace(".","").hashCode();let t=new Proxy(e,{set(t,r,o){if("string"!=typeof r)return(t[r]=o)||!0;for(let a of SF[SFKey.map][e[SFKey.key]][SFKey.beforeSetHooks])a.prop&&a.prop!=r||a.callback(t,r,o);t.hasAttribute&&t.hasAttribute(r)?t.setAttribute(r,o):t[r]=o;for(let a of SF[SFKey.map][e[SFKey.key]][SFKey.afterSetHooks])a.prop&&a.prop!=r||a.callback(t,r,o);return!0},get(e,t){if("string"!=typeof t)return e[t];switch(t){case"$":return e;case"after":case"before":case"firstChild":case"lastChild":case"firstElementChild":case"lastElementChild":case"parentElement":case"parentNode":return SF.asSF(e[t]);case"children":case"childNodes":return SF.asSFarr(e[t]);case"#text":return SF.asSFarr(Array.from(e.childNodes).filter(e=>"#text"==e.nodeName))}if(t.startsWith("$"))return SF.asSFarr(e.querySelectorAll(t.substr(1)));if(e.hasAttribute&&e.hasAttribute(t))return e.getAttribute(t);if(e.hasOwnProperty(t))return e[t];if(null!=e[t]&&null!=e[t])return e[t];if(e[SFKey.isRoot]&&document.getElementById(t))return SF.asSF(document.getElementById(t));if(e.childNodes){let r=Array.from(e.childNodes).filter(e=>e.nodeName==t.toUpperCase());if(r.length>0)return SF.asSFarr(r)}return e.querySelectorAll&&SF.asSFarr(e.querySelectorAll(t))},deleteProperty(t,r){if(!(r in t))return!1;if("string"==typeof r)for(let o of SF[SFKey.map][e[SFKey.key]][SFKey.beforeDelHooks])o.prop&&o.prop!=r||o.callback(t,r,t[r]);if(delete t[r],"string"==typeof r)for(let o of SF[SFKey.map][e[SFKey.key]][SFKey.afterDelHooks])o.prop&&o.prop!=r||o.callback(t,r,t[r]);return!0}});return SF[SFKey.map][e[SFKey.key]]=t,t[SFKey.beforeSetHooks]=[],t[SFKey.afterSetHooks]=[],t[SFKey.beforeDelHooks]=[],t[SFKey.afterDelHooks]=[],t}static asSFarr(e){let t=[];if(!e)return t;for(let r of e)t.push(SF.asSF(r));return 1==t.length?t[0]:t}static bindOneWay(e,t,r){SF.beforePropertySet(e,r,(e,r,o)=>{SF.asSF(t)[r]=o})}static bindTwoWay(e,t,r){SF.bindOneWay(e,t,r),SF.bindOneWay(t,e,r)}static beforePropertySet(e,t,r){SF.asSF(e)[SFKey.beforeSetHooks].push(new HookAction(t,(e,t,o)=>{e[t]!=o&&r(e,t,o)}))}static afterPropertySet(e,t,r){SF.asSF(e)[SFKey.afterSetHooks].push(new HookAction(t,(e,t,o)=>{r(e,t,o)}))}static beforePropertyDel(e,t,r){SF.asSF(e)[SFKey.beforeDelHooks].push(new HookAction(t,(e,t,o)=>{r(e,t,o)}))}static afterPropertyDel(e,t,r){SF.asSF(e)[SFKey.afterDelHooks].push(new HookAction(t,(e,t)=>{r(e,t)}))}static bindForm(e){e=e.$||e;let t=SF.asSF(SF.formToObject(e));SF.afterPropertySet(t,null,(e=>function(t,r,o){SF.jsonToForm(e,t,r)})(e)),SF.afterPropertyDel(t,null,(e=>function(t,r,o){SF.jsonToForm(e,t,r)})(e));for(let r of e.querySelectorAll("input,select,textarea")){let o=SF.debounce(SF.observeForm(e,(e=>function(t,r,o){e[t]=r})(t)),100);r.addEventListener("change",o),r.addEventListener("keyup",o)}return t}static observeForm(e,t){return(e=>function(r){let o=r.target;for(;o!=e&&!o.name;)o="LABEL"==o.tagName&&o.getAttribute("for")?document.getElementById(o.getAttribute("for")):o.parentElement;o!=e&&t(o.name,SF.formToObject(e,o.name)[o.name],o)})(e)}static formToObject(e,t){function r(r,o){if("SELECT"==r.tagName){let e=r.querySelectorAll("option:not([disabled]):checked");if(!e)return o;if(1==e.length)o[r.name]=e[0].value;else{o[r.name]=[];for(let t of e)o[r.name].push(t.value)}}else if(r.type&&"file"==r.type.toLowerCase())o[r.name]=Array.from(r.files).map(e=>e.name);else if(r.type&&"radio"==r.type.toLowerCase())if(t){let a=e.querySelector(`input[name=${t}][type=radio]:not([disabled]):checked`);o[r.name]=!a||a.value}else o[r.name]=r.checked;else r.type&&"checkbox"==r.type.toLowerCase()?o[r.name]=r.checked:o[r.name]=r.value;return o}let o={};if(t)r(e.querySelector(`[name=${t}]`),o);else{let t="input[name]:not([disabled]):not([type=radio]):not([type=checkbox])",a="input[name][type=radio]:not([disabled]):checked",l="input[name][type=checkbox]:not([disabled]):checked",s="textarea[name]:not([disabled])",n="select[name]:not([disabled])";for(let i of e.querySelectorAll(`${t},${a},${l},${s},${n}`))r(i,o)}return o}static jsonToForm(e,t,r){function o(e,r,o){let a=e.querySelector(`[name=${o}]`);if(a){switch(a.tagName){case"INPUT":switch((a.type||"").toLowerCase()){case"file":return;case"radio":return a=e.querySelector(`[name=${o}][value=${t[o]}]`),a&&(a.checked=Boolean(t[o]));case"checkbox":return a.checked=Boolean(t[o]);default:return a.value=t[o]||""}case"TEXTAREA":return a.value=t[o]||"";case"SELECT":for(let e of a.querySelectorAll("option:not([disabled])"))e.selected=!1;if(Array.isArray(r[o]))for(let e of r[o])a.querySelector(`option[value=${e}]`).selected=!0;else r[o]&&(a.querySelector(`option[value=${r[o]}]`).selected=Boolean(r[o]));return}console.log("??? target, form, obj, name â†“\n",a,e,r,o)}}if("string"==typeof t&&(t=JSON.parse(t)),r)return o(e,t,r);for(let r in t)o(e,t,r)}static asDataGrid(e,t){if("string"==typeof e&&e.startsWith("{")&&e.endsWith("}"))return SF.asDataGrid(JSON.parse(e));let r;return r=Array.isArray(e)?DataGrid.fromArray(e,t):"string"==typeof e?DataGrid.fromCSV(e,t):DataGrid.fromObject(e,t),r}static throttle(e,t,r){return r=r||{},function(o){let a=r.lastCall;r.lastCall=Date.now(),(!a||r&&r.fast||r.lastCall-a>t)&&e(o)}}static debounce(e,t,r){return r=r||{},function(o){let a=r.lastCall;r.lastCall=Date.now(),a&&r.lastCall-a<=t&&(r&&r.fast||clearTimeout(r.lastCallTimer)),r.lastCallTimer=setTimeout(()=>e(o),t)}}}SF[SFKey.map]=new Map,SF[SFKey.templates]=new Map,SF[SFKey.placeholder]=function(){},Object.freeze(SF);class HookAction{constructor(e,t){var r;this.active=new Set,this.counter=0,this.prop=e,this.callback=(r=t,function(){if(0==this.active.size){let e;this.active.add(e=this.counter++),r(...arguments),this.active.delete(e)}})}}class DataGrid{constructor(e,t,r){this.data=e,this.opt=t||{},this.cols=new ColGroup;for(let e=0;e<r.length;++e)this.cols.add(new Column(r[e],e,e))}static fromCSV(e,t){(t=t||{}).delimiter=t.delimiter||(e.split("\n",1)[0].replace(",","").length<e.split("\n",1)[0].replace("\t","").length?",":"\t"),t.quote=t.quote||'"',t.escape=t.escape||"\\\\",e=e.replace(/\r\n/gm,"\n");let r="ðŸš®";for(;e.search(r)>=0;)r+=r;e=e.replace(new RegExp(t.escape+t.quote,"gm"),r);let o=[],a=[];if(t.noHead){let t=l();for(let e=0;e<t.length;++e)o.push(e);for(a.push(i(t));e.length>0;)a.push(i(l()))}else o=l(),function(){const r=new RegExp(`^([^\n${t.delimiter}${t.quote}]*)${t.delimiter}`),l=new RegExp(`^([^${t.delimiter}${t.quote}]*)\n`),s=new RegExp(`^${t.quote}([\\s\\S\n]*?)${t.quote}(${t.delimiter}|\n)?`,"mi");let c,u=[];for(;e.length>0;)(c=r.exec(e))?(u.push(c[1]),e=e.replace(r,"")):(c=l.exec(e))?(u.push(c[1]),e=e.replace(l,"")):(c=s.exec(e))?(u.push(c[1]),e=e.replace(s,"")):(u.push(e),e=""),u.length==o.length&&(a.push(i(n(u))),u=[])}();return new DataGrid(a,t,o);function l(){let r="";e.search("\n")>=0?(r=e.split("\n",1)[0],e=e.slice(r.length+1)):(r=e,e="");let o,a=[],l=r.split(t.delimiter),i=!1;for(let e=0;e<l.length;++e)if(i){if(l[e].endsWith(t.quote)){a.push(o+s(l[e])),i=!1;continue}o=o+l[e]+t.delimiter}else{if(o=l[e],o.startsWith(t.quote)&&o.endsWith(t.quote)&&o.length>=2*t.quote.length){a.push(s(o));continue}if(o.startsWith(t.quote)){o=s(o),o+=t.delimiter,i=!0;continue}a.push(o)}return n(a)}function s(e){return e.replace(new RegExp(t.quote,"g"),"")}function n(e){for(let o=0;o<e.length;++o)e[o]=e[o].replace(new RegExp(r,"gm"),t.quote);return e}function i(e){let t={};for(let r=0;r<o.length;++r)t[o[r]]=e[r]||"";return t}}static fromArray(e,t){let r=(t=t||{}).names;if(!r&&t.hasHead){if(r=[],Array.isArray(e[0]))r=e[0];else for(let t in e[0])r.push(""+t);e=e.slice(1)}let o=[];if(Array.isArray(e[0])){r||(r=[]);for(let t of e)o.push(a(t))}else{let t=new Set;for(let r of e){for(let e in r)t.add(""+e);o.push(r)}r||(r=Array.from(t))}return new DataGrid(o,t,r);function a(e){let t={};for(let o=0;o<e.length;++o)r.length<=o&&r.push(o),t[r[o]]=e[o]||"";return t}}static fromObject(e,t){let r=[];for(let t in e)r.push(e[t]);return DataGrid.fromArray(r)}getHeight(){return this.data.length}getWidth(){return this.cols.size()}getRows(e,t,r){e=e||0,t=t||this.getHeight();let o=[];for(let a=e;a<t;++a)r&&!r(this.data[a])||o.push(this.data[a]);return new DataGrid(o,this.opt,this.cols.columns().map(e=>e.name))}getColumns(e,t,r){e=e||0,t=t||this.getWidth();let o=this.cols.columnsByDisplayOrder(),a=[];for(let l=e;l<t;++l)r&&!r(o[l])||a.push(o[l]);let l=[];for(let e of this.data){let t={};for(let r of a)t[r.name]=e[r.name];l.push(t)}return new DataGrid(l,this.opt,a.map(e=>e.name))}getTableForm(){let e="<form><table></table></form>".asSF(),t=document.createElement("tr");for(let e of this.cols.columnsByDisplayOrder())t.append(`<th>${e.name}</th>`.asSF().$);e.table.$.append(t);for(let r=0;r<this.data.length;++r){t=document.createElement("tr");for(let e of this.cols.columnsByDisplayOrder())t.append(`<td><textarea class="sf-datagrid-cell" name="C${r}-${e.name}">${this.data[r][e.name]||""}</textarea></td>`.asSF().$);e.table.$.append(t)}for(let t of e.$.querySelectorAll("textarea")){let r=SF.debounce(SF.observeForm(e.$,(e,t,r)=>{let[o,a]=e.match(/C(\d+)-(.+)/).slice(1);this.data[o][a]=t,r.style.height=r.scrollHeight+2}),100);t.addEventListener("change",r),t.addEventListener("keyup",r)}return e.$}}class Column{constructor(e,t,r){this.name=e,this.realIdx=t,this.dispIdx=r}}class ColGroup{constructor(e){this.cols=new Set(e||[])}columns(){return Array.from(this.cols)}columnsByDisplayOrder(){return this.columns().sort((e,t)=>e.dispIdx-t.dispIdx)}size(){return this.cols.size}add(e){this.cols.add(e)}remove(e){this.cols.delete(e)}removeBy(e){for(let t of this.columns())e(t)&&this.remove(t)}removeByName(e){this.removeBy((function(e){e.name}))}removeByRealIdx(e){this.removeBy((function(e){e.realIdx}))}removeByDisplayIdx(e){this.removeBy((function(e){e.dispIdx}))}swapDisplayOrder(e,t){for(let r of this.columns())r.dispIdx==e?r.dispIdx=t:r.dispIdx==t&&(r.dispIdx=e)}}