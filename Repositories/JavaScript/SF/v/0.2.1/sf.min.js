String.prototype.hashCode||(String.prototype.hashCode=function(){let e,t,o=0;if(0===this.length)return o;for(e=0;e<this.length;e++)t=this.charCodeAt(e),o=(o<<5)-o+t,o|=0;return o}),String.prototype.asSF=function(){let e=document.createElement("template");switch(e.insertAdjacentHTML("afterbegin",this),e.childElementCount){case 0:return null;case 1:return SF.asSF(e.firstChild);default:return SF.asSFarr(e.children)}};class SFKey{}SFKey.map=Symbol("SFNode map"),SFKey.key=Symbol("SFNode's key"),SFKey.templates=Symbol("SF template map"),SFKey.placeholder=Symbol("Placeholder function. Do nothing"),SFKey.isRoot=Symbol("If true, this.$ == root element"),SFKey.beforeSetHooks=Symbol("Before set hook list"),SFKey.afterSetHooks=Symbol("After set hook list"),SFKey.beforeDelHooks=Symbol("Before delete hook list"),SFKey.afterDelHooks=Symbol("After delete hook list"),Object.freeze(SFKey);class SF{static build(e){e||(e=document.querySelector("[sf]")),e[SFKey.isRoot]=!0;let t=this.asSF(e);return t.newTemplate=function(e,t){let o=new Proxy(SF[SFKey.placeholder],{apply:function(e,o,n){let r=t().asSF();return 1==n.length?n[0](r):n.length>1&&n[0](r,...n.slice(1)),r}});return SF[SFKey.templates][e]=o,o},t.asTemplate=function(e,t){return this.newTemplate(e,()=>t.outerHTML)},t}static asSF(e){if(!e)return e;if(e[SFKey.key]&&SF[SFKey.map][e[SFKey.key]])return SF[SFKey.map][e[SFKey.key]];e[SFKey.key]=`${(new Date).getTime()}__${Math.random()}`.replace(".","").hashCode();let t=new Proxy(e,{set(t,o,n){if("string"!=typeof o)return(t[o]=n)||!0;for(let r of SF[SFKey.map][e[SFKey.key]][SFKey.beforeSetHooks])r.prop&&r.prop!=o||r.callback(t,o,n);t.hasAttribute&&t.hasAttribute(o)?t.setAttribute(o,n):t[o]=n;for(let r of SF[SFKey.map][e[SFKey.key]][SFKey.afterSetHooks])r.prop&&r.prop!=o||r.callback(t,o,n);return!0},get(e,t){if("string"!=typeof t)return e[t];switch(t){case"$":return e;case"after":case"before":case"firstChild":case"lastChild":case"firstElementChild":case"lastElementChild":case"parentElement":case"parentNode":return SF.asSF(e[t]);case"children":case"childNodes":return SF.asSFarr(e[t]);case"#text":return SF.asSFarr(Array.from(e.childNodes).filter(e=>"#text"==e.nodeName))}if(e.hasAttribute&&e.hasAttribute(t))return e.getAttribute(t);if(e.hasOwnProperty(t))return e[t];if(void 0!=e[t]&&null!=e[t])return e[t];if(e[SFKey.isRoot]&&document.getElementById(t))return SF.asSF(document.getElementById(t));if(e.childNodes){let o=Array.from(e.childNodes).filter(e=>e.nodeName==t.toUpperCase());if(o.length>0)return SF.asSFarr(o)}return e.querySelectorAll&&SF.asSFarr(e.querySelectorAll(t))},deleteProperty(t,o){if(!(o in t))return!1;if("string"==typeof o)for(let n of SF[SFKey.map][e[SFKey.key]][SFKey.beforeDelHooks])n.prop&&n.prop!=o||n.callback(t,o,t[o]);if(delete t[o],"string"==typeof o)for(let n of SF[SFKey.map][e[SFKey.key]][SFKey.afterDelHooks])n.prop&&n.prop!=o||n.callback(t,o,t[o]);return!0}});return SF[SFKey.map][e[SFKey.key]]=t,t[SFKey.beforeSetHooks]=[],t[SFKey.afterSetHooks]=[],t[SFKey.beforeDelHooks]=[],t[SFKey.afterDelHooks]=[],t}static asSFarr(e){let t=[];if(!e)return t;for(let o of e)t.push(SF.asSF(o));return 1==t.length?t[0]:t}static bindOneWay(e,t,o){SF.beforePropertySet(e,o,(e,o,n)=>{SF.asSF(t)[o]=n})}static bindTwoWay(e,t,o){SF.bindOneWay(e,t,o),SF.bindOneWay(t,e,o)}static beforePropertySet(e,t,o){SF.asSF(e)[SFKey.beforeSetHooks].push(new HookAction(t,(e,t,n)=>{e[t]!=n&&o(e,t,n)}))}static afterPropertySet(e,t,o){SF.asSF(e)[SFKey.afterSetHooks].push(new HookAction(t,(e,t,n)=>{o(e,t,n)}))}static beforePropertyDel(e,t,o){SF.asSF(e)[SFKey.beforeDelHooks].push(new HookAction(t,(e,t,n)=>{o(e,t,n)}))}static afterPropertyDel(e,t,o){SF.asSF(e)[SFKey.afterDelHooks].push(new HookAction(t,(e,t)=>{o(e,t)}))}static bindForm(e){e=e.$||e;let t=SF.asSF(SF.formToObject(e));SF.afterPropertySet(t,null,(e=>(function(t,o,n){SF.jsonToForm(e,t,o)}))(e)),SF.afterPropertyDel(t,null,(e=>(function(t,o,n){SF.jsonToForm(e,t,o)}))(e));for(let o of e.querySelectorAll("input,select,textarea"))o.onchange=o.onkeyup=SF.debounce(SF.observeForm(e,(e=>(function(t,o,n){e[t]=o}))(t)),100);return t}static observeForm(e,t){return(e=>(function(o){let n=o.target;for(;n!=e&&!n.name;)n="LABEL"==n.tagName&&n.getAttribute("for")?document.getElementById(n.getAttribute("for")):n.parentElement;n!=e&&t(n.name,SF.formToObject(e,n.name)[n.name],n)}))(e)}static formToObject(e,t){function o(o,n){if("SELECT"==o.tagName){let e=o.querySelectorAll("option:not([disabled]):checked");if(!e)return n;if(1==e.length)n[o.name]=e[0].value;else{n[o.name]=[];for(let t of e)n[o.name].push(t.value)}}else if(o.type&&"file"==o.type.toLowerCase())n[o.name]=Array.from(o.files).map(e=>e.name);else if(o.type&&"radio"==o.type.toLowerCase())if(t){let r=e.querySelector(`input[name=${t}][type=radio]:not([disabled]):checked`);n[o.name]=!r||r.value}else n[o.name]=o.checked;else o.type&&"checkbox"==o.type.toLowerCase()?n[o.name]=o.checked:n[o.name]=o.value;return n}let n={};if(t)o(e.querySelector(`[name=${t}]`),n);else{let t="input[name]:not([disabled]):not([type=radio]):not([type=checkbox])",r="input[name][type=radio]:not([disabled]):checked",a="input[name][type=checkbox]:not([disabled]):checked",i="textarea[name]:not([disabled])",l="select[name]:not([disabled])";for(let s of e.querySelectorAll(`${t},${r},${a},${i},${l}`))o(s,n)}return n}static jsonToForm(e,t,o){function n(e,o,n){let r=e.querySelector(`[name=${n}]`);if(r){switch(r.tagName){case"INPUT":switch((r.type||"").toLowerCase()){case"file":return;case"radio":return(r=e.querySelector(`[name=${n}][value=${t[n]}]`))&&(r.checked=Boolean(t[n]));case"checkbox":return r.checked=Boolean(t[n]);default:return r.value=t[n]||""}case"TEXTAREA":return r.value=t[n]||"";case"SELECT":for(let e of r.querySelectorAll("option:not([disabled])"))e.selected=!1;if(Array.isArray(o[n]))for(let e of o[n])r.querySelector(`option[value=${e}]`).selected=!0;else o[n]&&(r.querySelector(`option[value=${o[n]}]`).selected=Boolean(o[n]));return}console.log("??? target, form, obj, name â†“\n",r,e,o,n)}}if("string"==typeof t&&(t=JSON.parse(t)),o)return n(e,t,o);for(let o in t)n(e,t,o)}static throttle(e,t,o){return function(n){let r=this.lastCall;this.lastCall=Date.now(),(!r||o&&o.fast||this.lastCall-r>t)&&e(n)}}static debounce(e,t,o){return function(n){let r=this.lastCall;this.lastCall=Date.now(),r&&this.lastCall-r<=t&&(o&&o.fast||clearTimeout(this.lastCallTimer)),this.lastCallTimer=setTimeout(()=>e(n),t)}}}SF[SFKey.map]=new Map,SF[SFKey.templates]=new Map,SF[SFKey.placeholder]=function(){},Object.freeze(SF);class HookAction{constructor(e,t){this.active=new Set,this.counter=0,this.prop=e,this.callback=(e=>(function(){if(0==this.active.size){let t;this.active.add(t=this.counter++),e(...arguments),this.active.delete(t)}}))(t)}}