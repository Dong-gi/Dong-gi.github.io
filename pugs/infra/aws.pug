include ../../source/skeleton.pug
+post('AWS', 'AWS', 'AWS 정리')
    h1 참고자료
    ul
        li: +asA('https://docs.aws.amazon.com/index.html', 'AWS 공식 문서')
        li: +asA('https://explore.skillbuilder.aws/learn', 'AWS 공식 - Learning Center')
        li: +asA('https://aws.amazon.com/ko/architecture/security-identity-compliance/', 'AWS 공식 - 보안 Best Practice')

    h1 Auto Scaling
    div
        h2 크기 조정 계획
        ul
            li 크기 조정 계획을 지원하는 서비스들에 대한 auto scaling을 손쉽게 구성할 수 있다
                +asA('https://docs.aws.amazon.com/ko_kr/autoscaling/application/userguide/integrated-services-list.html')
            li Aurora : Aurora DB 클러스터의 읽기 전용 복제본 개수에 관해 설정
            li EC2 : EC2 Auto Scaling 그룹의 용량에 관해 설정
            li ECS : 태스크 수에 관해 설정
            li DynamoDB : 읽기 및 쓰기 용량에 관해 설정
            li ElastiCache for Redis : 복제본 개수에 관해 설정
            li 각 서비스별 사용 가능한 지표가 다르다
                +asA('https://docs.aws.amazon.com/ko_kr/autoscaling/application/userguide/application-auto-scaling-target-tracking.html')

        h2 EC2 Auto Scaling
        ul
            li Auto Scailing 그룹의 최소 용량, 원하는 용량, 최대 용량을 지정하여 서비스 처리량 유지
            li Auto Scailing 그룹의 인스턴스 수명 주기
            ul
                li Pending : 신규 인스턴스 시작
                li Pending:Wait : autoscaling:EC2_INSTANCE_LAUNCHING 후크가 존재하는 경우 Pending에서 천이됨
                p e.g. 새 인스턴스에 CodeDeploy 개정을 자동으로 배포할 수 있다 -- Auto Scailing 그룹을 포함하도록 배포 그룹을 생성하거나 업데이트할 때, CodeDeploy 서비스 역할을 사용하여 Auto Scailing 그룹에 수명 주기 후크를 자동 설치
                li Pending:Proceed : 수명 주기 후크 완료 시 천이됨
                li InService : 인스턴스 구성 완료
                li Terminating : 인스턴스 종료 시작
                li Terminating:Wait : autoscaling:EC2_INSTANCE_TERMINATING 후크가 존재하는 경우 Terminating에서 천이됨
                li Terminating:Proceed : 수명 주기 후크 완료 시 천이됨
                li Terminated : 인스턴스 종료 완료
            li 인스턴스는 다음 중 하나가 발생할 때까지 InService 상태로 유지된다
            ul
                li 축소 이벤트 발생
                li 인스턴스를 Standby 상태로 천이
                li Auto Scailing 그룹으로부터 분리
                li 상태 확인 실패 임계 도달
            li Standby 상태(대기모드)
            p 인스턴스가 실행 중인 상태에서 서비스 풀에서 분리
            li 간편한 모니터링 및 인스턴스 자동 조정 정책(평균 CPU 사용, 인스턴스 당 요청 수, 특정 시간대 등) 지원

    h1 CDK, CloudFormation
    div
        h2 CloudFormation이란?
        ul
            li 템플릿에 인프라에 필요한 모든 리소스를 기술하고, 템플릿을 이용해 CloudFormation 스택을 생성하면, 필요한 리소스들을 자동으로 프로비저닝한 후 실행한다
            li 전체 인프라 복제를 신속히 배포할 때 유용
            li 템플릿은 JSON 또는 YAML 포맷이어야 한다
            li 온라인 템플릿 편집기 제공:
                +asA('https://console.aws.amazon.com/cloudformation/designer')
            li 업데이트 배포 가능
            ol
                li 템플릿 내용 또는 입력 파라미터의 변경을 제출하여 변경 집합 생성
                li 변경 집합의 변경 사항 검토
                p 계정 할당량, 업데이트를 지원하지 않는 리소스를 변경하려는 경우, 실행 권한이 부족한 경우를 사전에 확인하지 않음에 유의
                li 변경 집합 시작 : 변경 사항들만 기존 스택에 적용

        h2 시작하기
        p 로컬 MySQL을 사용하는 단일 EC2 인스턴스로 WordPress 서비스 제공하는 샘플 템플릿을 통해 기본적인 사항을 알아본다
            +asA('https://s3.us-west-2.amazonaws.com/cloudformation-templates-us-west-2/WordPress_Single_Instance.yaml', '원본 yaml')
        +asCode('yaml').
            AWSTemplateFormatVersion: '2010-09-09'

            Description: 'AWS CloudFormation Sample Template WordPress_Single_Instance: WordPress
              is web software you can use to create a beautiful website or blog. This template
              installs WordPress with a local MySQL database for storage. It demonstrates using
              the AWS CloudFormation bootstrap scripts to deploy WordPress. **WARNING** This template
              creates an Amazon EC2 instance. You will be billed for the AWS resources used if
              you create a stack from this template.'

            Parameters:
              DBName:
                AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
                ConstraintDescription: must begin with a letter and contain only alphanumeric
                  characters.
                Default: wordpressdb
                Description: The WordPress database name
                MaxLength: '64'
                MinLength: '1'
                Type: String
              DBPassword:
                AllowedPattern: '[a-zA-Z0-9]*'
                ConstraintDescription: must contain only alphanumeric characters.
                Description: The WordPress database admin account password
                MaxLength: '41'
                MinLength: '8'
                NoEcho: 'true'
                Type: String
              DBRootPassword:
                AllowedPattern: '[a-zA-Z0-9]*'
                ConstraintDescription: must contain only alphanumeric characters.
                Description: MySQL root password
                MaxLength: '41'
                MinLength: '8'
                NoEcho: 'true'
                Type: String
              DBUser:
                AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
                ConstraintDescription: must begin with a letter and contain only alphanumeric
                  characters.
                Description: The WordPress database admin account username
                MaxLength: '16'
                MinLength: '1'
                NoEcho: 'true'
                Type: String
              InstanceType:
                AllowedValues:
                - t2.micro
                - t2.small
                ConstraintDescription: must be a valid EC2 instance type.
                Default: t2.small
                Description: WebServer EC2 instance type
                Type: String
              KeyName:
                ConstraintDescription: must be the name of an existing EC2 KeyPair.
                Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
                Type: AWS::EC2::KeyPair::KeyName
              SSHLocation:
                AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
                ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
                Default: 0.0.0.0/0
                Description: The IP address range that can be used to SSH to the EC2 instances
                MaxLength: '18'
                MinLength: '9'
                Type: String

            Mappings:
              AWSInstanceType2Arch:
                t2.micro:
                  Arch: HVM64
                t2.small:
                  Arch: HVM64
              AWSRegionArch2AMI:
                us-east-1:
                  HVM64: ami-60b6c60a
                  HVMG2: ami-e998ea83
                  PV64: ami-5fb8c835
                us-west-1:
                  HVM64: ami-d5ea86b5
                  HVMG2: ami-943956f4
                  PV64: ami-56ea8636

            Resources:
              WebServer:
                Type: AWS::EC2::Instance
                CreationPolicy:
                  ResourceSignal:
                    Timeout: PT15M
                Metadata:
                  AWS::CloudFormation::Init:
                    configSets:
                      wordpress_install:
                      - install_cfn
                      - install_wordpress
                      - configure_wordpress
                    configure_wordpress:
                      commands:
                        01_set_mysql_root_password:
                          command: !Sub |
                            mysqladmin -u root password '${DBRootPassword}'
                          test: !Sub |
                            $(mysql ${DBName} -u root --password='${DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? != 0 ))
                        02_create_database:
                          command: !Sub |
                            mysql -u root --password='${DBRootPassword}' &lt; /tmp/setup.mysql
                          test: !Sub |
                            $(mysql ${DBName} -u root --password='${DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? !=0))
                        03_configure_wordpress:
                          command: /tmp/create-wp-config
                          cwd: /var/www/html/wordpress
                    install_cfn:
                      files:
                        /etc/cfn/cfn-hup.conf:
                          content: !Sub |
                            [main]
                            stack= ${AWS::StackId}
                            region=${AWS::Region}
                          group: root
                          mode: '000400'
                          owner: root
                        /etc/cfn/hooks.d/cfn-auto-reloader.conf:
                          content: !Sub |
                            [cfn-auto-reloader-hook]
                            triggers=post.update
                            path=Resources.WebServer.Metadata.AWS::CloudFormation::Init
                            action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebServer --configsets wordpress_install --url https://stackbuilder.amazonaws.com
                          group: root
                          mode: '000400'
                          owner: root
                      services:
                        sysvinit:
                          cfn-hup:
                            enabled: true
                            ensureRunning: true
                            files:
                            - /etc/cfn/cfn-hup.conf
                            - /etc/cfn/hooks.d/cfn-auto-reloader.conf
                    install_wordpress:
                      files:
                        /tmp/create-wp-config:
                          content: !Sub |
                            #!/bin/bash -xe
                            cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php
                            sed -i "s/'database_name_here'/'${DBName}'/g" wp-config.php
                            sed -i "s/'username_here'/'${DBUser}'/g" wp-config.php
                            sed -i "s/'password_here'/'${DBPassword}'/g" wp-config.php
                          group: root
                          mode: '000500'
                          owner: root
                        /tmp/setup.mysql:
                          content: !Sub |
                            CREATE DATABASE ${DBName};
                            CREATE USER '${DBUser}'@'localhost' IDENTIFIED BY '${DBPassword}';
                            GRANT ALL ON ${DBName}.* TO '${DBUser}'@'localhost';
                            FLUSH PRIVILEGES;
                          group: root
                          mode: '000400'
                          owner: root
                      packages:
                        yum:
                          httpd: []
                          mysql: []
                          mysql-devel: []
                          mysql-libs: []
                          mysql-server: []
                          php: []
                          php-mysql: []
                      services:
                        sysvinit:
                          httpd:
                            enabled: true
                            ensureRunning: true
                          mysqld:
                            enabled: true
                            ensureRunning: true
                      sources:
                        /var/www/html: http://wordpress.org/latest.tar.gz
                Properties:
                  ImageId: !FindInMap [AWSRegionArch2AMI, !Ref 'AWS::Region', !FindInMap [AWSInstanceType2Arch, !Ref InstanceType, Arch]]
                  InstanceType:
                    Ref: InstanceType
                  KeyName:
                    Ref: KeyName
                  SecurityGroups:
                  - Ref: WebServerSecurityGroup
                  UserData:
                    Fn::Base64: !Sub |
                      #!/bin/bash -xe
                      yum update -y aws-cfn-bootstrap
                      /opt/aws/bin/cfn-init -v --stack ${AWS::StackId} --resource WebServer --configsets wordpress_install --region ${AWS::Region}
                      /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource WebServer --region ${AWS::Region}

              WebServerSecurityGroup:
                Type: AWS::EC2::SecurityGroup
                Properties:
                  GroupDescription: "Enable HTTP access via port 80 locked down to the load balancer + SSH access"
                  SecurityGroupIngress:
                  - CidrIp: 0.0.0.0/0
                    FromPort: '80'
                    IpProtocol: tcp
                    ToPort: '80'
                  - CidrIp: !Ref SSHLocation
                    FromPort: '22'
                    IpProtocol: tcp
                    ToPort: '22'

            Outputs:
              PublicIP:
                Description: EC2 public IP
                Value: !GetAtt WebServer.PublicIp
              WebsiteURL:
                Description: WordPress Website
                Value: !Sub "http://${WebServer.PublicDnsName}/wordpress"

        ol
            li 샘플은 6개의 최상위 섹션을 갖지만(AWSTemplateFormatVersion, Description, Parameters, Mappings, Resources, Outputs), 이 중 Resources 섹셕만 필수 요소다
            li Resources.WebServer : 템프릿 내에서 리소스 참조에 사용하는 논리적 이름
            li Parameters : 템플릿에서 사용할 변수 정의
            p Ref 함수로 parameter와 resource 접근
            ul
                li Resources.WebServer.Properties.KeyName = { Ref: "KeyName" }
                li Resources.WebServer.Properties.SecurityGroups[0] = { Ref: "WebServerSecurityGroup" }
            li Outputs 섹션은 스택 생성 후 출력 탭에서 확인할 수 있는 값을 정의한다

        h2 샘플 템플릿
        ul
            li: +asA('https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/CHAP_TemplateQuickRef.html', '서비스별 샘플 템플릿')
            li: +asA('https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-sample-templates.html', '리전별 샘플 템플릿')

        h2 CDK(Cloud Development Kit)
        p 고급 프로그래밍 언어를 이용해 인프라 작성 > CloudFormation 템플릿 자동 생성 > 스택 배포
        h3.fake 예시 :
            +asA('https://docs.aws.amazon.com/cdk/v2/guide/hello_world.html')
        ol
            li CDK 설치 :
                +asA('https://docs.aws.amazon.com/cdk/v2/guide/cli.html')
            +asCode('shell') npm install -g aws-cdk
            li 앱 생성(JavaScript)
            +asCode('shell').
                mkdir hello-cdk
                cd hello-cdk
                cdk init app --language javascript
            li ^ 정상인지 확인
            +asCode('shell') cdk ls
            p HelloCdkStack가 결과에 포함되어야 한다
            li 서비스 구성요소 추가
            +asCode('JavaScript', 'lib/hello-cdk-stack.js').
                const cdk = require('aws-cdk-lib');
                const s3 = require('aws-cdk-lib/aws-s3');

                class HelloCdkStack extends cdk.Stack {
                    constructor(scope, id, props) {
                        super(scope, id, props);

                        new s3.Bucket(
                            this,               // Scope
                            'MyFirstBucket',    // Id
                            {                   // Properties
                                versioned: true
                            }
                        );
                    }
                }

                module.exports = { HelloCdkStack }
            li CloudFormation 템플릿 생성
            +asCode('shell') cdk synth
            p YAML 포맷의 템플릿이 출력되며, cdk.out 디렉터리에 JSON 포맷 템플릿도 작성된다
            li 스택 배포
            +asCode('shell') cdk deploy
            li 스택 정의 업데이트 -- 스택 삭제 시 모든 객체와 버킷을 삭제하도록
            +asCode('JavaScript', 'lib/hello-cdk-stack.js').
                new s3.Bucket(
                    this,               // Scope
                    'MyFirstBucket',    // Id
                    {                   // Properties
                        versioned: true,
                        removalPolicy: cdk.RemovalPolicy.DESTROY,
                        autoDeleteObjects: true
                    }
                );
            li 변경 사항 확인
            +asCode('shell') cdk diff
            ul
                li 객체 자동 삭제를 위해 Lambda 함수가 추가되는 것을 볼 수 있다
                li 추가적으로 cdk synth의 결과를 비교해보는 것도 유용할 수 있다
            li 스택 업데이트 배포
            +asCode('shell') cdk deploy
            li 스택 제거
            +asCode('shell') cdk destroy

    h1 EC2
    div
        h2 개요
        ul
            li 인스턴스 : 가상 컴퓨팅 환경
            li AMI(Amazon machine image) : 인스턴스에서 실행할 운영체제 및 소프트웨어들이 적절히 구성된 상태. 이를 이용해 동일한 상태로 여러 인스턴스들을 쉽게 만들 수 있다
            li 인스턴스 유형 : 인스턴스의 CPU, 메모리, 스토리지, 네트워크 대역폭 구성
            li 키 페어 : 암호화된 인스턴스 로그인 강제
            li 인스턴스 스토어 볼륨 : 임시 데이터 저장. 인스턴스 중단, 최대 절전 모드 전환, 종료 시 삭제
            li EBS : 영구 스토리지 볼륨
            li 보안 그룹 : 인스턴스 방화벽 기능
            li 탄력적 IP(EIP) : 고정 IPv4 주소
            li
    details
        summary 정리 필요
        h2 스팟 인스턴스
        ul
            li 미사용 중인 EC2 인스턴스 풀에서 인스턴스를 저렴하게 임대하여 사용할 수 있다
            li 인스턴스 풀은 계속 변동되므로 스팟 요금 역시 계속 변동되고, 가장 높은 가격으로 주문한 사용자가 우선 낙찰된다
            li 가격, 용량 등에 대한 제약사항을 설정하여 주문하는데, 수요 증가로 인하여 언제든지 종료될 수 있다
            p 종료 2분전 발행되는 종료 공지를 이용해 인스턴스가 중단되기 전에 상태 저장, 로그 업로드 등의 작업을 할 수 있다
            li 스팟 인스턴스 어드바이저 : 리전 - 인스턴스 유형별 중단 빈도 제공
                +asA('https://aws.amazon.com/ko/ec2/spot/instance-advisor/')
        h2 Amazon Linux 2
        div
            h3 CodeDeploy agent 설치
            +asCode('shell').
                $ sudo yum install ruby -y
                $ sudo yum install wget -y

                # 리전에 따라 아래 url은 달라짐
                $ wget https://aws-codedeploy-ap-northeast-2.s3.amazonaws.com/latest/install
                $ chmod +x ./install
                $ sudo ./install auto
                $ sudo service codedeploy-agent status

            h3 JDK(corretto) 설치
            +asCode('shell').
                $ sudo rpm --import https://yum.corretto.aws/corretto.key
                $ sudo curl -L -o /etc/yum.repos.d/corretto.repo https://yum.corretto.aws/corretto.repo
                $ sudo yum install -y java-17-amazon-corretto-devel

            h3 aws configure
            p 인스턴스 내에서 aws cli 명령을 실행하려는 경우, 미리 자격 증명을 설정하는 것이 편리하다

            h3 시작 템플릿 > 사용자 데이터에서 CodeDeploy 실행
            +asCode('bash').
                #!/bin/bash
                aws deploy create-deployment --application-name AppName --deployment-config-name CodeDeployDefault.OneAtATime --deployment-group-name GroupName --s3-location bucket=BucketName,bundleType=zip,key=ObjectKey
        h2 Amazon Linux 2022
        ul
            li AL2022부터 Amazon Linux의 새로운 메이저 버전은 2년마다 출시
            li 각 메이저 버전은 총 5년 동안 지원됨 : 2년 표준 지원(분기별 마이너 업데이트) + 3년 유지 관리
            li SELinux 기본 설정
            li 라이브 패치 : 재부팅, 가동 중단 없이 커널 패치 가능

    h1 IAM; Identity and Access Management
    div
        h2 AWS 계정
        ul
            li AWS 계정은 AWS의 기초적인 보안 경계, 리소스 경계, 책임 경계가 된다
            li AWS 각 서비스 제한량 역시 AWS 계정을 기준으로 부여할 수 있다

        h2 AWS Organizations
        ul
            li 여러 AWS 계정을 조직에 통합하여 중앙에서 관리하는 서비스
            li 효율적인 조직 비용 관리 가능
            li 최대 5단계의 OU(조직 그룹) 트리 구성 가능
            li 조직 관리자가 정의한 제한은 개별 멤버 계정 관리자보다 우선

        h2 IAM이란?
        ul
            li 단일 계정 내 인증 및 권한 관리 서비스
            li 암호나 액세스 키를 공유하지 않고도 권한 부여
            li 세분화된 권한 관리
            li 다른 곳에 암호가 있는 사용자에게 임시 액세스 권한 부여
            li AWS는 PCI DSS 1 레벨1 서비스 공급자 인증을 받음
            li IAM과 STS는 추가 비용 없이 제공됨
        div
            h3 IAM 작동 방식
            div
                h4.fake Terms
                ul
                    li IAM 리소스
                    p 사용자, 그룹, 정책, 자격 증명 공급자 객체는 다른 AWS 서비스와 마찬가지로 IAM에서 추가, 편집, 제거 가능한 리소스다
                    li IAM 자격 증명
                    p 사용자(영구 자격 증명 사용), 그룹, 역할(임시 보안 자격 증명 사용). 식별 및 그룹화에 사용되는 IAM 리소스 객체로, 정책을 이에 연결할 수 있다
                    li IAM 엔터티
                    p 사용자, 역할. AWS가 인증에 사용하는 IAM 리소스 객체
                    li 보안 주체
                    p AWS 루트 사용자, IAM 사용자, IAM 역할을 사용하여 AWS에 요청하는 사람 또는 애플리케이션
                    li 최소 권한 원칙
                    p 필요한 경우에만 승격된 권한을 사용하도록 제한

                h4.fake Request
                p 보안 주체가 AWS Management Console, AWS API, AWS CLI를 사용해 전송하는 요청에는 다음의 정보가 포함된다 -- 요청 컨텍스트
                ul
                    li 수행하고자 하는 작업
                    li 작업 대상이 되는 AWS 리소스 객체
                    li 요청을 보내는 보안 주체
                    li 환경 데이터 : IP 주소, User agent, SSL 사용 여부 등
                    li 리소스 객체와 연관된 데이터 : EC2 인스턴스 태그 등

                h4.fake Authorization
                p AWS는 요청 컨텍스트에 적용되는 각 정책을 확인하여, 하나라도 거부되는 경우 전체 요청을 거부하고 평가를 중지한다. 아래는 요청 평가에 대한 일반 규칙
                ol
                    li 기본적으로 모든 요청은 거부
                    li 정책에 포함된 명시적 허용은 위 거부를 재정의
                    li 권한 경계 또는 세션 정책이 있는 경우 위 허용을 재정의
                    li 정책의 명시적 거부는 위 허용을 무시

            h3 ABAC란?
            ul
                li ABAC(Attribute based access control)는 보안 주체와 리소스의 태그가 일치할 때 권한을 부여한다
                li 동종 리소스에 대한 동일 작업에 대한 정책 하나만 가지고도 각 보안 주체가 각각 필요한 리소스에만 접근할 수 있게 한다

        h2 IAM 시작하기 > IAM 관리자 및 사용자 그룹 생성
        ol
            li 루트 사용자로 로그인
            li 탐색 표시줄 > 내 계정 > 결제 정보에 대한 IAM 사용자 및 역할 액세스 편집 > IAM 액세스 활성
            p 관리자 사용자가 비용 및 사용량과 상호작용하려면 위 작업 필요
            li IAM 콘솔에서 관리자 사용자 추가. 여러 명인 경우 사용자 그룹도 추가
            li 사용자 또는 사용자 그룹에 AdministratorAccess 정책 연결

        h2 자습서
        div
            h3 역할을 사용하여 AWS 계정 간 권한 위임
            ol
                li 리소스를 가진 계정(A)에서 리소스 액세스 역할 생성
                p 역할 생성 시, 신뢰할 수 있는 엔터티 유형으로 "다른 AWS 계정" 지정
                li 권한을 위임받고자 하는 계정(B)에서 적절한 IAM 보안 주체에 AssumeRole 허용 정책 연결
                +asCode('json', '인라인 정책 예').
                    {
                        "Version": "2012-10-17",
                        "Statement": {
                            "Effect": "Allow",
                            "Action": "sts:AssumeRole",
                            "Resource": "arn:aws:iam::ACCOUNT-A-ID:role/ROLE-NAME"
                        }
                    }
                li 역할 전환 테스트
                ul
                    li AWS 콘솔
                    ul
                        li 역할 전환 시 ExternalId를 요구하지 않아야만 가능
                        li 방법 1 : 역할 생성 시 Role Summary 페이지에서 제공된 url 사용
                        li 방법 2 : 탐색 표시줄 > Switch Role > 계정 ID 또는 alias, 역할 이름 수동 입력
                    li AWS CLI
                    +asCode('shell', 'aws-cli').
                        aws sts assume-role --role-arn "ROLE-ARN" --role-session-name "ARBITRARY-SESSION-NAME"

                        # 환경 변수로 세션 키 설정
                        export AWS_ACCESS_KEY_ID="GIVEN-BY-ASSUME-ROLE"
                        export AWS_SECRET_ACCESS_KEY="GIVEN-BY-ASSUME-ROLE"
                        export AWS_SESSION_TOKEN="GIVEN-BY-ASSUME-ROLE"
                    li AWS API
                    p AssumeRole 호출 응답으로 주어진 임시 자격 증명을 사용하여 API 호출

            h3 ABAC 사용
            ul
                li "access-" 접두사를 가진 역할에 대해, 사용자 태그와 역할 태그가 일치하는 경우 역할 전환할 수 있는 정책 예
                +asCode('json').
                    {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Sid": "TutorialAssumeRole",
                                "Effect": "Allow",
                                "Action": "sts:AssumeRole",
                                "Resource": "arn:aws:iam::ACCOUNT-ID:role/access-*",
                                "Condition": {
                                    "StringEquals": {
                                        "iam:ResourceTag/team": "${aws:PrincipalTag/team}",
                                        "iam:ResourceTag/project": "${aws:PrincipalTag/project}"
                                    }
                                }
                            }
                        ]
                    }
                li SAML 세션 태그를 이용해 역할 전환하는 정책 예
                +asCode('json').
                    {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Sid": "AllowSamlIdentityAssumeRole",
                                "Effect": "Allow",
                                "Action": [
                                    "sts:AssumeRoleWithSAML",
                                    "sts:TagSession"
                                ],
                                "Principal": {
                                    "Federated": "arn:aws:iam::123456789012:saml-provider/ExampleCorpProvider"
                                },
                                "Condition": {
                                    "StringLike": {
                                        "aws:RequestTag/team": [
                                            "engineer",
                                            "qa"
                                        ],
                                        "aws:RequestTag/project": "*"
                                    },
                                    "StringEquals": {
                                        "SAML:aud": "https://signin.aws.amazon.com/saml"
                                    }
                                }
                            }
                        ]
                    }
                li 보안 주체 태그와 리소스 태그가 일치하는 경우 권한을 인가하는 정책 예
                +asCode('json').
                    {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Sid": "AllActionsSecretsManagerSameProjectSameTeam",
                                "Effect": "Allow",
                                "Action": "secretsmanager:*",
                                "Resource": "*",
                                "Condition": {
                                    "StringEquals": {
                                        "aws:ResourceTag/team": "${aws:PrincipalTag/team}",
                                        "aws:ResourceTag/project": "${aws:PrincipalTag/project}"
                                    }
                                }
                            }
                        ]
                    }
                li ABAC로 권한을 부여받은 보안 주체가 태그 및 리소스 기반 정책을 변경하지 못하도록 하는 정책 예
                +asCode('json').
                    {
                        "Version": "2012-10-17",
                        "Statement": [
                            {
                                "Sid": "DenyUntagSecretsManagerReservedTags",
                                "Effect": "Deny",
                                "Action": "secretsmanager:UntagResource",
                                "Resource": "*",
                                "Condition": {
                                    "ForAnyValue:StringLike": {
                                        "aws:TagKeys": "*"
                                    }
                                }
                            },
                            {
                                "Sid": "DenyPermissionsManagement",
                                "Effect": "Deny",
                                "Action": "secretsmanager:*Policy",
                                "Resource": "*"
                            }
                        ]
                    }

        h2 ID
        div
            h3 Roles
            div
                h4.fake 역할을 사용할 수 있는 주체
                ul
                    li 동일한 AWS 계정의 IAM 사용자
                    li 다른 AWS 계정의 IAM 사용자
                    li AWS 서비스(EC2 등)
                    li SAML 2.0, OpenID Connect 등 외부 자격 증명 공급자(IdP)에 의해 인증된 외부 사용자

                h4.fake EC2 애플리케이션에서 역할 사용
                p EC2 인스턴스에 IAM 역할을 할당하면 장기 자격 증명을 인스턴스에 배포하지 않아도 된다. 예를 들어, AWS Java SDK에서 인증 정보 없이 서비스 클라이언트 인스턴스 생성 시 DefaultAWSCredentialsProviderChain에 정의된 순서대로 인증 정보를 조회한다
                ol
                    li 환경 변수 : AWS_ACCESS_KEY, AWS_SECRET_KEY
                    p Java SDK 외의 경우엔 AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY
                    li Java System Properties : aws.accessKeyId, aws.secretKey
                    li Web Identity Token credential
                    li Credential profile : ~/.aws/credentials
                    li Amazon EC2 container service로 전달되는 인증 정보
                    li Amazon EC2 metadata service로 전달되는 인증 정보
                p 인스턴스 내부에서 aws cli를 직접 실행하는 경우엔 얘기가 다르다. profile을 추가로 지정해야 하고, 해당 profile로 assume role할 수 있는 권한이 있어야 한다

            +pos('CloudTrail을 사용하여 이벤트 로깅')
            h3 CloudTrail을 사용하여 이벤트 로깅
            ul
                li CloudTrail은 IAM, STS 호출을 이벤트로 캡처한다
                li 글로벌 리전 서비스가 아닌 경우, 이벤트는 한 리전에만 로깅된다
                li 추적을 생성하면 이벤트를 S3 버킷으로 배포할 수 있다
                li 추적을 생성하지 않아도 Event history에서 90일 간의 기록을 무료로 확인 가능
            div
                h4.fake CloudTrail 이벤트
                ul
                    li 관리 이벤트 : 관리 작업에 대한 정보
                    p e.g. 보안 구성, 로깅 설정 등
                    li 데이터 이벤트 : 리소스 작업에 대한 정보
                    p e.g. 버킷 및 객체 수준 API, Lambda 실행, DynamoDB 객체 수준 API
                    li Insignts 이벤트 : 비정상적인 API 호출 비율, 오류 비율 캡처

        h2 액세스 관리
        div
            h3 정책 및 권한
            div
                h4.fake 정책 유형
                ul
                    li 자격 증명 기반 정책 : 관리형 및 인라인 정책을 보안 주체에 연결
                    li 리소스 기반 정책 : 인라인 정책을 리소스에 연결. e.g. S3 버킷 정책, IAM 역할 신뢰 정책
                    li 권한 경계 : 부여할 수 있는 최대 권한 정의
                    li Organizations SCP : 조직 단위 계정 멤버에 대한 최대 권한 정의
                    li ACL : JSON 정책 문서 구조를 사용하지 않고, 액세스할 수 있는 보안 주체 목록으로 제어
                    li 세션 정책 : 역할 또는 페더레이션 사용자에 대해 임시 세션을 프로그래밍 방식으로 생성할 때 파라미터로 전달하는 고급 정책

                h4.fake JSON 정책 언어 문법(2012-10-17)
                +asCode().
                    policy  = {
                        &lt;version_block?&gt;
                        &lt;id_block?&gt;
                        &lt;statement_block&gt;
                    }

                    &lt;version_block&gt; = "Version" : ("2008-10-17" | "2012-10-17")

                    &lt;id_block&gt; = "Id" : &lt;policy_id_string&gt;

                    &lt;statement_block&gt; = "Statement" : [ &lt;statement&gt;, &lt;statement&gt;, ... ]

                    &lt;statement&gt; = {
                        &lt;sid_block?&gt;,
                        &lt;principal_block?&gt;,
                        &lt;effect_block&gt;,
                        &lt;action_block&gt;,
                        &lt;resource_block&gt;,
                        &lt;condition_block?&gt;
                    }

                    &lt;sid_block&gt; = "Sid" : &lt;sid_string&gt;

                    &lt;effect_block&gt; = "Effect" : ("Allow" | "Deny")

                    &lt;principal_block&gt; = ("Principal" | "NotPrincipal") : ("*" | &lt;principal_map&gt;)

                    &lt;principal_map&gt; = { &lt;principal_map_entry&gt;, &lt;principal_map_entry&gt;, ... }

                    &lt;principal_map_entry&gt; = ("AWS" | "Federated" | "Service" | "CanonicalUser") :
                        [&lt;principal_id_string&gt;, &lt;principal_id_string&gt;, ...]

                    &lt;action_block&gt; = ("Action" | "NotAction") :
                        ("*" | [&lt;action_string&gt;, &lt;action_string&gt;, ...])

                    &lt;resource_block&gt; = ("Resource" | "NotResource") :
                        ("*" | [&lt;resource_string&gt;, &lt;resource_string&gt;, ...])

                    &lt;condition_block&gt; = "Condition" : { &lt;condition_map&gt; }
                    &lt;condition_map&gt; = {
                        &lt;condition_type_string&gt; : { &lt;condition_key_string&gt; : &lt;condition_value_list&gt; },
                        &lt;condition_type_string&gt; : { &lt;condition_key_string&gt; : &lt;condition_value_list&gt; }, ...
                    }
                    &lt;condition_value_list&gt; = [&lt;condition_value&gt;, &lt;condition_value&gt;, ...]
                    &lt;condition_value&gt; = ("string" | "number" | "Boolean")
                ul
                    li Version : 정책 언어 버전
                    li Id : 정책 식별자
                    li Statement : 1개 이상의 세부 정책
                    li Sid : 세부 정책 식별자. API에서 참조되는 값이 아니며, 정책에 대한 서술을 적어도 좋다
                    li Effect : 세부 정책이 허가/거부를 나타내는 지 여부
                    li Principal : 리소스 기반 JSON 정책에서, 허가/거부의 대상이 될 보안 주체 지정
                    li NotPrincipal : Principal과 반대로, 여집합을 지정
                    p "Effect": "Deny"와 함께, 지정한 보안 주체를 제외한 모든 보안 주체에 대해 명시적으로 거부하는 드문 경우에 사용
                    li Action : 대상 작업 목록. 작업 이름은 대소문자 구별 없음. 와일드카드 * 가능
                    li NotAction : Action과 반대로, 여집합을 지정
                    li Resource : 대상 리소스 ARN 목록. 와일드카드 *, ? 가능
                    li NotResource : Resource와 반대로, 여집합을 지정
                    li Condition : 요청 컨텍스트에 대한 추가 조건 연산

                h4.fake 정책 조건 연산
                ul
                    li 조건 키는 대소문자 구별 없음. aws:ResourceTag/<i class="w3-red">tag-key</i>처럼 키 일부를 사용자가 지정할 수 있는 경우에도 마찬가지로 대소문자 구별 없음에 유의
                    p 조건 키로 다음 2가지가 가능:
                        +asA('https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/reference_policies_condition-keys.html', '전역 조건 키')
                        |,
                        +asA('https://docs.aws.amazon.com/ko_kr/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html#context_keys_table', '서비스별 조건 키')
                    li 각 조건 키의 평가 결과는 다음 중 하나 : true, false, not present, null(빈 문자열)
                    li 조건 연산자
                    table.no-sort
                        +ths('연산자', '설명', '대응 Not 연산자')
                        +tds('문자열 조건 연산자', '정책 변수 사용 가능', '')
                        +tds('StringEquals', '대소문자 구별한 문자열 일치', 'StringNotEquals')
                        +tds('StringEqualsIgnoreCase', '대소문자 무시한 문자열 일치', 'StringNotEqualsIgnoreCase')
                        +tds('StringLike', '대소문자 구별한 문자열 일치. 와일드카드 *, ? 허용', 'StringNotLike')
                        +tds('숫자 조건 연산자', '정책 변수 사용 불가. 정수 또는 십진수 비교', '')
                        +tds('NumericEquals', '일치', 'NumericNotEquals')
                        +tds('NumericLessThan', '미만', 'NumericGreaterThanEquals')
                        +tds('NumericLessThanEquals', '이하', 'NumericGreaterThan')
                        +tds('날짜 조건 연산자', '정책 변수 사용 불가. ISO 8601 포맷 또는 UNIX epoch 비교', '')
                        +tds('DateEquals', '일치', 'DateNotEquals')
                        +tds('DateLessThan', '미만', 'DateGreaterThanEquals')
                        +tds('DateLessThanEquals', '이하', 'DateGreaterThan')
                        +tds('부울 조건 연산자', '정책 변수 사용 불가. 키를 "true" 또는 "false"와 비교', '')
                        +tds('Bool', '일치', '')
                        +tds('이진 조건 연산자', '정책 변수 사용 불가', '')
                        +tds('BinaryEquals', '지정한 Base64 인코딩 표시와 바이트 단위로 일치', '')
                        +tds('IP 주소 조건 연산자', '정책 변수 사용 불가', '')
                        +tds('IpAddress', '지정 CIDR에 포함', 'NotIpAddress')
                        +tds('ARN 조건 연산자', '정책 변수 사용 가능. ARN의 콜론으로 구분된 6개 구성요소 각각 별도로 확인한다', '')
                        +tds('ArnEquals, ArnLike', '대소문자 구별한 ARN 일치. 와일드카드 *, ? 허용', 'ArnNotEquals, ArnNotLike')
                        +tds('…IfExists 조건 연산자', 'Null을 제외한 조건 연산자 이름 끝에 IfExists를 추가하면 요청 컨텍스트에 정책 키가 없으면 true로 평가', '')
                        +tds('Null', '정책 변수 사용 불가. 조건 키의 유무 검사', '')
                    li 한 정책에 다수의 조건 연산자가 있는 경우 : AND 평가
                    li 한 조건 연산자에 다수의 키가 추가된 경우 : AND 평가
                    li 한 조건 키에 다수의 값이 포함된 경우 : OR 평가
                    li 값 자체가 다중인 경우, 조건 집합 연산자를 사용할 수 있다
                    ul
                        li ForAllValues : 요청 컨텍스트의 값 집합이 지정한 조건 키 집합의 부분집합
                        li ForAnyValue : 요청 컨텍스트의 값 집합 원소 중 하나라도 지정한 조건 키 집합의 원소
                        +asCode().
                            "Condition": {
                                "ForAnyValue:StringEquals": {
                                    "dynamodb:Attributes": [ "ID", "Message" ]
                                }
                            }

                    li 정책 변수 및 태그
                    ul
                        li Resource 요소에서의 사용 : ARN의 5번째 콜론 뒷부분만
                        +asCode() "Resource": ["arn:aws:s3:::bucket/${aws:PrincipalTag/department}"]
                        li Condition 요소에서의 사용 : 허용되는 조건 연산자에서만
                        +asCode().
                            "Condition": {
                                "StringLike": {
                                    "iam:ResourceTag/costCenter": [ "12345", "67890" ]
                                }
                            }
                        li 모든 요청에 사용할 수 있는 정보
                        table
                            +tds('aws:CurrentTime', '현재 시각')
                            +tds('aws:EpochTime', '현재 시각')
                            +tds('aws:TokenIssueTime', '임시 보안 자격 증명 발급 시각')
                            +tds('aws:PrincipalType', '보안 주체 종류 : Account, User, FederatedUser, AssumedRole, Anonymous(S3, SNS, SQS)')
                            +tds('aws:SecureTransport', 'SSL 요청인지 여부')
                            +tds('aws:SourceIp', '요청자 IP')
                            +tds('aws:UserAgent', '신뢰성이 떨어지는 클라이언트 정보')
                            +tds('aws:userid', '보안 주체 고유 ID')
                            +tds('aws:username', 'IAM 사용자 이름')
                            +tds('ec2:SourceInstanceARN', 'EC2에 할당된 IAM 역할을 이용해 들어온 요청인 경우 인스턴스 ARN이 설정됨')
                        li 서비스별 정보
                        p s3:prefix, s3:max-keys, s3:x-amz-acl, sns:Endpoint, sns:Protocol, ...
                        li 특수 문자 리터럴 표현
                        ul
                            li ${*} : 문자 * 표현
                            li ${?} : 문자 ? 표현
                            li ${$} : 문자 $ 표현
                        li 변수가 없는 경우 사용할 기본값 제공
                        +asCode() "Resource":"arn:aws:s3:::DOC-EXAMPLE-BUCKET-${aws:PrincipalTag/team, 'company-wide'}"

                h4.fake: +asA('https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/access_policies_examples.html', '정책 예제')
                ul
                    li MFA 설정 허용 정책
                    +asCode('json').
                        {
                            "Version": "2012-10-17",
                            "Statement": [
                                {
                                    "Sid": "VisualEditor0",
                                    "Effect": "Allow",
                                    "Action": [
                                        "iam:DeactivateMFADevice",
                                        "iam:DeleteVirtualMFADevice",
                                        "iam:EnableMFADevice",
                                        "iam:ResyncMFADevice",
                                        "iam:CreateVirtualMFADevice",
                                        "iam:ListMFADevices"
                                    ],
                                    "Resource": [
                                        "arn:aws:iam::123456789012:mfa/${aws:username}",
                                        "arn:aws:iam::123456789012:user/${aws:username}"
                                    ]
                                },
                                {
                                    "Sid": "VisualEditor1",
                                    "Effect": "Allow",
                                    "Action": "iam:ListVirtualMFADevices",
                                    "Resource": "*"
                                }
                            ]
                        }

        h2 액세스 분석기
        p IAM Access Analyzer는 외부 엔터티와 공유되는 조직 및 계정 내 리소스를 식별하여 액세스가 의도한 액세스인지, 의도하지 않은 보안 위험인지 확인할 수 있다. 모든 상용 AWS 리전에서 무료로 IAM 콘솔 및 API를 통해 이용 가능

    h1 Proton
    div
        h2 개요
        p 컨테이너 기반 서버리스 애플리케이션에 대한 2가지 자동화를 제공한다. 템플릿 생성, 게시, 관리에는 비용이 청구되지 않는다
        ol
            li 플랫폼 관리자가 정의한 IaC(infrastructure as code) 템플릿대로 인프라를 자동 구축
            p 플랫폼 관리자는 버전 관리되는 환경 및 서비스 템플릿을 정의한다. 환경 템플릿은 서비스들이 공유하는 인프라 집합을 정의하고, 서비스 템플릿은 각 서비스가 필요로 하는 인프라 요소들을 정의한다
            li 통합된 CI/CD 기능을 통해 코드 자동 배포

        h2 시작하기
        +w3img('/imgs/20220428_1158.png', 'Proton service diagram')
        ul
            li 데모:
                +asA('https://www.youtube.com/watch?v=uQDmHRjQpTU')
            li 샘플 코드:
                +asA('https://github.com/aws-samples/aws-proton-sample-templates/tree/main/loadbalanced-fargate-svc')
        ol
            li 환경 템플릿 생성 ~ 배포
            ul
                li 템플릿에 필요한
                    +asA('https://docs.aws.amazon.com/proton/latest/adminguide/parameters.html', '인자')
                    |들을 식별 후
                    +asA('https://docs.aws.amazon.com/proton/latest/adminguide/ag-schema.html', '스키마 파일')
                    |로 작성
                li IaC 파일 작성
                ul
                    li AWS 관리형으로 만드는 경우 : CloudFormation 템플릿 파일에,
                        +asA('https://palletsprojects.com/p/jinja/', 'Jinja')
                        |를 이용해 변수 사용
                    li 고객 관리형으로 만드는 경우 :
                        +asA('https://www.terraform.io/', 'Terraform')
                        |템플릿 파일
                li 스키마 + IaC + 매니페스트 파일들을 번들링
                li 템플릿 번들을 참조하여 템플릿 생성(또는 업데이트) 후 템플릿 게시 및 배포
            li 배포한 특정 버전의 환경 템플릿에 인자를 지정하여 환경 생성
            li 서비스 템플릿 생성 ~ 배포
            li 서비스 생성에 사용할 코드 저장소 - 브랜치 작성
            li 배포한 특정 버전의 서비스 템플릿에 인자와 코드 저장소 및 브랜치를 지정하여 서비스 및 서비스 인스턴스 생성
            li 최종적으로 개발자가 지정한 환경에 지정한 수량만큼의 서비스 인스턴스가 생성된다

    h1 WAF, Firewall Manager, Shield
    div
        h2 개요
        ul
            li WAF(Web application firewall)
            p 규칙(e.g. 시간-IP당 요청 수)을 기반으로 HTTP/HTTPS 요청에 대한 허용/거부(403 Forbidden) 결정
            li Shield
            ul
                li DDoS 보호 서비스
                li Shield Standard : 기본 제공
                li Shield Advanced : 고급 기능 제공(월 3,000 USD)
            li Firewall Manager
            p 조직의 계정과 애플리케이션 방화 규칙에 대한 중앙 관리 서비스

        h2 WAF
        ul
            li Web ACL : 액세스를 결정하는 규칙 리스트. 규칙은 ACL 제한 용량까지만 추가 가능
            li Rule : 각 규칙은 조건식을 가지며, 조건식을 만족하는 요청에 대해 허용/거부/카운트/CAPTCHA 중 어느 것을 실행할 지 결정한다
            li Rule group : 재사용 가능한 규칙
        div
            h3 Rule
            div
                h4.fake Rule action
                ul
                    li Allow : 요청 허용
                    p 요청에 커스텀 헤더 추가 가능
                    li Count : 카운터 증가. 나머지 규칙 평가
                    p 요청에 커스텀 헤더 추가 가능. 이후 규칙 평가를 위한 커스텀 레이블 추가 가능
                    li Block : 요청 거부
                    li CAPTCHA : 캡차 실행

                h4.fake Rule type
                ul
                    li Regular rule : 조건 일치 요청에 대해 개별 action 결정
                    li Rate-based rule : 기간(5분) 중 동일 IP에 대해 임계값 초과한 요청에 대해 action 결정

                h4.fake Rule statement
                ul
                    li 모든 요청에 대해 action 실행
                    li IP 기반 국가 코드 일치하는 요청에 대해 action 실행
                    li IP 집합 포함 요청에 대해 action 실행
                    li Label 소지 요청에 대해 action 실행
                    li Header 패턴 일치 요청에 대해 action 실행
                    li Query 패턴 일치 요청에 대해 action 실행
                    li URI 패턴 일치 요청에 대해 action 실행
                    li Body 패턴 일치 요청에 대해 action 실행
                    p 최대 8KB만 평가한다
                    li HTTP method 패턴 일치 요청에 대해 action 실행
                +asCode('json', 'Rule 예시').
                    {
                        "Name": "RequestRate-by-IP",
                        "Priority": 0,
                        "Statement": {
                            "RateBasedStatement": {
                                "Limit": 1500,
                                "AggregateKeyType": "IP"
                            }
                        },
                        "Action": {
                            "Block": {}
                        },
                        "VisibilityConfig": {
                            "SampledRequestsEnabled": true,
                            "CloudWatchMetricsEnabled": true,
                            "MetricName": "RequestRate-by-IP"
                        }
                    }

    h1 기타 서비스
    ul
        li AppConfig
        p 애플리케이션 런타임 환경 배포 -- StartConfigurationSession로 세션을 수립한 클라이언트는 GetLatestConfiguration을 (주기적으로) 호출하여 구성을 가져온다
        li Chatbot
        ul
            li SNS(Simple Notificatino Service)로부터 Amazon Chime 또는 Slack으로의 통지
            li Amazon Chime 또는 Slack에서 챗봇 IAM 역할로 명령 실행
        li CLI
        p 셸을 이용해 브라우저 기반 AWS Management Console과 동일하게 AWS 서비스와 상호작용
        li CloudTrail
        p 보안 주체 활동 로깅
            +goto('CloudTrail을 사용하여 이벤트 로깅')
        li CloudWatch
        p AWS 리소스 및 애플리케이션 모니터링
        li GuardDuty
        p 계정 내의 비정상적인 활동을 식별하고, 활동의 보안 관련성을 분석하며, 호출된 컨텍스트를 제공
        li Health
        p AWS 인프라 이벤트(오류 발생, 복구 등), 예정된 변경 사항 및 영향 받은 리소스에 대해 안내
        li Managed Service for Prometheus
        p Prometheus 호환, 자동 확장 컨테이너 모니터링 서비스
        li Network Firewall
        p VPC 경계 트랙픽 관리 방화. 보안 그룹만으로 불충분한 경우 사용
        li Resource Group
        p 리소스들을 그룹화하여 여러 리소스에 대한 작업을 한 번에 실행. 지원하는 서비스 목록:
            +asA('https://docs.aws.amazon.com/ARG/latest/userguide/integrated-services-list.html')
        li Secrets Manager
        p 암호 중앙 관리자. 암호 검색 API 제공
        li Security Hub
        p 자동화된 보안 검사 -&gt; 우선순위가 높은 보안 문제 식별


        li EC2; Elastic Compute Cloud
        p OS를 포함한 컴퓨팅 머신
        li EBS; Elastic Block Store
        p EC2를 위한 스토리지(SSD)
        li EFS; Elastic File System
        ul
            li 용량 제약 없는 분산 네트워크 파일 시스템
            li 동시에 수천 개의 인스턴스가 사용할 수 있다
            li EBS보다 지연시간은 느리지만, 단위 시간당 처리량은 높다
            p 높은 IOPS에는 부적합
        li Elastic Beanstalk
        p 웹 앱 배포. Java, .NET, PHP, Node, Python, Ruby, Go, Docker...
        li S3; Simple Storage Service
        p 99.999999999% 내구성. 크기 무제한
        li S3 Glacier
        p 저렴한 데이터 아카이빙 S3 스토리지
        li ELB; Elastic Load Balancing
        p EC2 인스턴스, 컨테이너, IP 주소, Lambda 함수 등으로의 부하 분산
        li VPC; Virtual Private Cloud
        p 사용자 정의 가상 네트워크
        li RDS; Relational Database Service
        p Amazon Aurora, PostgreSQL, MySQL, MariaDB, Oracle Database, SQL Server
        li Database Migration Service
        p 기존 데이터베이스를 AWS RDS로 마이그레이션
        li ElastiCache
        p Redis, Memcached
        li CloudFront
        p 글로벌 CDN
        li Route 53
        p 엔드 유저의 요청을 적절한 EC2 인스턴스, ELB, S3 버킷 등으로 연결하는 DNS
        li Simple Queue Service
        p 메시지 큐
        li Simple Notification Service
        p Pub/Sub 푸시 기반 메시징 서비스. 모바일 푸시, SMS, 이메일 등 가능
        li Simple Email Service
        li Organizations
        ul
            li 조직을 나누어 각 조직에 멤버 계정을 생성해 할당할 수 있다
            li 각 조직에 대한 정책을 정의할 수 있다
            li 단일 마스터 계정이 모든 비용을 지불한다

    h1 싱글 웹서버
    ol
        li 규모가 작은 경우, API 게이트웨이 + 람다 조합이 더 저렴할 수 있다
        li EC2 인스턴스 생성
        p Auto-assign Public IP : Disable // 자동 할당되는 IP는 인스턴스가 시작할 때마다 변경된다
            br
            |Shutdown behavior : Stop // Terminate는 OS 정지 후 EC2 인스턴스 삭제
            br
            |Enable termination protection : 실수로 인스턴스 삭제되는 것을 방지
        li EC2 보안 그룹 설정
        p SSH | TCP | 22 | 작업 IP
            br
            |HTTP | TCP | 80 | 0.0.0.0/0
            br
            |HTTPS | TCP | 443 | 0.0.0.0/0
        li 고정 퍼블릭 IP(EIP; Elastic IP) 부여
        p AWS 관리 콘솔에서 Allocate New Address → 우클릭 → Associate Address
        li 도메인 연결 : Route 53
        p Create Record Set → Name : FQDN, Type : CNAME - Canon name, Value : EIP
        li EC2 인스턴스 삭제 시
        p Enable termination protection 해제 후 Terminate
            br
            |연결된 EBS, EIP 삭제

    h1 VPC
    ol
        +w3img('/imgs/security-diagram.png')
        li AWS 계정 생성시 VPC, 서브넷, 라우팅 테이블, 인터넷 게이트웨이, 네트워크 ACL 등은 가용 리전 및 AZ에 대해 기본적으로 생성된다
        p NAT 게이트웨이 등 사용자가 필요에 의해 직접 추가하는 리소스들은 추가 요금이 발생함에 유의
        li VPC; Virtual Private Cloud
        p AWS 계정 및 AWS 리전에 대해 고유한 전용 네트워크
        li AZ; Availability Zone, 가용 영역
        p AWS 리전은 2개 이상의 가용 영역으로 구성되며, 각 AZ는 서로의 장애로부터 물리적으로 격리된다
        li Subnet
        ul
            li VPC 내 할당 가능한 IP 주소 영역의 일부. AZ 안에 서브넷을 작성할 수 있으며, 다른 AZ와 공유되지 않는다
            li Private subnet 안에서 생성된 인스턴스에는 public IP가 부여되지 않는다
            p 또는 인스턴스 실행 시 public IP 부여 여부를 결정할 수 있으며, 인터넷 게이트웨이와 연결되지 않은 라우팅 테이블에 서브넷을 연결하면 결과적으로 public IP가 없는 것과 같은 효과를 갖는다
        li Route table
        p VPC 내부↔외부 네트워크 트래픽을 제어하는 규칙 정의. 라우팅 테이블 : 서브넷 = 1 : N 관계
        li Internet gateway
        ul
            li VPC 내부와 외부 인터넷 사이의 연결 통로
            li VPC 내 인스턴스 → 외부 인터넷 : 트래픽의 송신 주소를 인스턴스의 public IP/Elastic IP로 설정
            li 외부 인터넷 → VPC 내 인스턴스 : 트래픽의 수신 주소를 인스턴스의 private IP로 설정
        li NAT gateway
        ul
            li private 서브넷 내의 인스턴스가 외부 인터넷과 연결을 맺을 수 있도록 해준다
            p 외부 인터넷이 먼저 연결을 시작할 수는 없다
            li VPC 내 인스턴스 → 외부 인터넷 : 트래픽의 송신 주소를 NAT의 Elastic IP로 설정
            li 외부 인터넷 → VPC 내 인스턴스 : 트래픽의 수신 주소를 인스턴스의 private IP로 설정
        li VPC endpoint
        p 인터넷 게이트웨이를 거치지 않고, VPC 내 인스턴스와 AWS 서비스 또는 엔드포인트 서비스 사이의 직접적인 연결 지원
        li NIC; Network Interface Controller
        p 서브넷 내에서, 특정 보안 그룹 집합을 갖는 NIC를 생성할 수 있다. 인스턴스 : NIC = 1 : N 관계이며, 결과적으로 인스턴스는 N개의 private IP 주소를 할당받는다
        li Network ACL; Network Access Control List
        p 서브넷(들)에 대한 선택적인 방화벽 계층
        table
            caption 보안 그룹과 네트워크 ACL 비교
            +ths('Security group', 'Network ACL')
            +tds('인스턴스 단위 동작', '서브넷 단위 동작')
            +tds('허가 규칙만 존재', '허가 + 거부 규칙 존재')
            +tds('Is stateful: 응답은 무조건 허가', 'Is stateless: 응답도 규칙에 의해 허가되어야 한다')
            +tds('규칙은 순서 없이 모두 평가', '규칙은 우선순위에 의해 순차적으로 평가')
            +tds('적용된 인스턴스에 한해 적용', '서브넷에 포함된 모든 인스턴스에 자동 적용(따라서 선택적인 보안 계층을 제공함을 의미)')
        li VPC peering connection
        p 두 VPC(서로 다른 AWS 계정이어도 됨) 사이의 연결 지원. 인터넷 게이트웨이, VPN을 거치지 않고 각자의 private IP를 이용하여 AWS backbone을 통해 다이렉트로 암호화된 통신 가능
        li Client VPN
        p OpenVPN을 이용한 사용자 PC와 VPC 사이의 VPN 지원. private IP 주소를 이용한 인스턴스 접근이 가능해진다
        li Site-to-Site VPN
        p VPC와 사용자 네트워크 사이의 VPN 터널 유지
        li Traffic Mirroring
        p 두 EC2 인스턴스 사이의 트래픽을 미러링할 수 있다. ALB도 AWS 관리 EC2 인스턴스이므로, EC2 - ALB 사이의 트래픽도 확인할 수 있다.
            +asA('https://sjakthol.github.io/posts/alb-vpc-traffic-mirroring/', '참고 자료')

    h1 서버 다중화
    ol
        li ELB 설정
        p ELB는 엔드 유저의 요청을 받아야 하므로 0.0.0.0/0 소스 허용
            br
            |EC2 인스턴스 등은 ELB를 거친 연결만 허용하도록 보안 그룹 소스 변경
            br
            |ELB의 로드밸런서 프로토콜을 HTTPS, 인스턴스의 프로토콜을 HTTP로 하면 ELB가 SSL 처리를 모두 담당
        li RDS의 DB 다중화(Master-Standby)
        p 관리 콘솔 → RDS 설정 → DB 서브넷 그룹 작성 : 두 AZ 각각에 작성한 서브넷을 그루핑
            br
            |RDS 인스턴스 생성 시 멀티-AZ 옵션으로 DB 서브넷 그룹 지정
            br
            |RDS는 강제 업그레이드가 실행될 수 있으며, 멀티-AZ를 이용하는 경우, 스탠바이 서버부터 업그레이드되어 새로운 마스터가 된다

    h1 CloudFront
    div
        h2 캐시 정책 TTL 관련
        ul
            li 캐시 정책의 min, max, default TTL을 모두 31536000으로 설정해도 제대로 적용되지 않는 것으로 확인된다(2022-01-06)
            li 객체 속성 &gt; 메타데이터에서 Cache-Control값을 "public, max-age=31536000"으로 설정하는 것이 적용률이 높다
            p 그럼에도 불구하고 - 캐시 무효화를 3번이나 반복했음에도 - 모든 파일에 대해 캐시 관련 헤더가 제대로 설정되진 않았다(2022-01-06)

        h2 로드 밸런서를 원본으로 사용하는 경우 고려사항
        ul
            li GET 요청(캐시 대상)이 아닌 경우 성능이 나빠진다
            p 지리적으로 가장 가까운 엣지 포인트를 통해 AWS의 백본 네트워크를 이용하여 통신하므로 빨라질 것이라 기대해봤지만, 그렇지 않았다.
            ul
                li 테스트(2021-11-26) 조건 : 요청지@서울, 서버@us-east-2
                li 로드밸런서를 통해 직접 통신한 경우 190-200ms로 균일한 응답시간 확인
                li CDN을 거친 경우, 일부 요청은 10% 정도 빨리 응답(175ms 내외)되었지만, 절반 정도는 2배 이상 소요(670ms 내외)되었다.
            li 각 응답 캐시 시간을 Cache-Control: max-age 헤더로 조정
                +asA('https://aws.amazon.com/ko/premiumsupport/knowledge-center/cloudfront-cache-files-time/')
            li 쿼리 스트링 캐시 정책 조정
                +asA('https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/QueryStringParameters.html')

    h1 Lambda
    div
        h2 Lambda@Edge
        ul
            li CloudFront 요청/응답으로 트리거되는 람다 함수
            p 원본 이미지 1개에 대하여, 여러 사이즈의 캐시 응답을 생성하는 예시 :
                +asA('https://aws.amazon.com/ko/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/')
            li Lambda Layer는 지원되지 않는다
        div
            h3.fake 가능한 실행 지점
            ol
                li Viewer Request : CloudFront가 요청을 받아, 캐시를 검사하는 시점에 실행
                li Origin Request : 캐시에 항목이 없어 원본(origin)을 요청하는 시점에 실행
                li Origin Response : 원본(origin) 응답을 받은 이후, 캐시에 적재하기 전에 실행
                li Viewer Response : 응답을 엔드 유저에게 전달하기 전에 실행

    h1 특이 현상
    div
        h2 CPU 사용률이 100을 초과하는 현상(2022-01-21)
        p EC2 및 ElastiCache(Redis)에서 발생하였으며, 이 때문에 Auto Scaling 그룹의 자동 조정 정책 지표를 인스턴스 평균 CPU 사용률 대신 평균 ALB 요청 수로 변경함
        +w3img('/imgs/photo_2022-02-10 16.08.44.jpeg', 'EC2 스크린샷')
        +w3img('/imgs/photo_2022-02-10 16.16.52.jpeg', 'Redis 스크린샷')

        h2 WAF 규칙 적용 후 평균 응답 시간(P95, P99 포함 전부)이 획기적으로 단축된 것으로 보고되는 현상(2022-01-16)
        p ALB 통계에 포함되는 처리 시간 일부가 WAF 규칙 평가로 옮겨가서?
        +w3img('/imgs/photo_2022-02-10 16.21.20.jpeg')
