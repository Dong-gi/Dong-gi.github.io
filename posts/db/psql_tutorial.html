<hr>

<details>
    <summary>시작하기</summary>
    
    <details>
        <summary>설치</summary>
        <ul>
            <li><a role="button" target="_blank" class="btn btn-info btn-sm" href="http://postgresql.kr/docs/current/index.html">http://postgresql.kr/docs/current/index.html</a></li>
            <li><a role="button" target="_blank" class="btn btn-info btn-sm" href="https://www.postgresql.org/download/">https://www.postgresql.org/download/</a></li>
            <li><a role="button" target="_blank" class="btn btn-info btn-sm" href="https://wiki.postgresql.org/wiki/Frequently_Asked_Questions">https://wiki.postgresql.org/wiki/Frequently_Asked_Questions</a></li>

            <li><strong>PostgreSQL 9.6 on CentOS 6.9</strong></li>
            <ol>
                <li>Install the repository RPM</li>
                $ yum install https://download.postgresql.org/pub/repos/yum/9.6/redhat/rhel-6-x86_64/pgdg-centos96-9.6-3.noarch.rpm
        
                <li>Install the client packages</li>
                $ yum install postgresql96
        
                <li>Install the server packages</li>
                $ yum install postgresql96-server
        
                <li>Initialize the database</li>
                $ service postgresql-9.6 initdb
        
                <li>서비스 시작</li>
                $ service postgresql-9.6 start<br>
                $ service postgresql-9.6 restart // 재시작하는 경우
        
                <li>자동 구동 설정</li>
                $ chkconfig postgresql-9.6 on
            </ol>

            <li><strong>PostgreSQL 10 on CentOS 7</strong></li>
            <ol>
                <li>패키지 설치</li>
                rpm -Uvh https://yum.postgresql.org/10/redhat/rhel-7-x86_64/pgdg-centos10-10-2.noarch.rpm<br>
                yum install -y postgresql10-server postgresql10

                <li>DB 초기화</li>
                /usr/pgsql-10/bin/postgresql-10-setup initdb

                <li>서비스 시작</li>
                systemctl start postgresql-10<br>
                systemctl status postgresql-10 // 상태 확인

                <li>자동 구동 설정</li>
                systemctl enable postgresql-10
            </ol>

            <li>서비스 시작 후, 실행 위치 확인</li>
            $ ps aux | grep postgres
        </ul>
    </details>
            
    <details>
        <summary>기본 구조</summary>
        postgres라는 이름의 서버 프로세스가 항시 실행되면서 클라이언트의 연결 요청 시 이를 처리하고, 연결 수립 시 하위 프로세스를 생성하여 할당한다.
    </details>

    <details>
        <summary>데이터베이스 사용하기</summary>
        <ul>
            <li>데이터베이스 사용 방법</li>
            <ol>
                <li>psql : PostgreSQL 대화형 터미널 프로그램</li>
                <li>pgAdmin : PostgreSQL GUI 클라이언트 프로그램</li>
            </ol>

            <li>psql을 이용한 데이터베이스 사용</li>
            <ol>
                <li><strong>psql [options...] [dbname [username]]</strong></li>
                접속할 DB와 유저가 명시되지 않은 경우 : 현재 명령어를 실행하는 유저로, 같은 이름의 DB에 접속 시도한다.<br>
                처음 PostgreSQL을 설치하면, "postgres"를 이름으로 하는 메인 유저와 데이터베이스가 생성된다. 메인 유저의 최초 패스워드는 모른다. postgres 유저를 이용하는 것은 보안상 좋지 않으므로 프로젝트 별로 계정을 할당하는 것이 좋다.

                <li>옵션</li>
                <ul>
                    <li>-d dbname : 데이터베이스 지정.</li>
                    <li>-e : 쿼리 에코 출력</li>
                    <li>-h hostname : 원격지 설정</li>
                    <li>-p port : 포트 설정</li>
                    <li>-U username : 유저 설정.</li>
                    <li>-s : 명령을 하나씩 확인하면서 실행</li>
                </ul>

                <li>psql 사용자 관련</li>
                <ul>
                    <li>postgres 계정으로 db 접속</li>
                    $ su -<br>
                    $ psql postgres
                    
                    <li>사용자 추가</li>
                    리눅스<br>
                    $ adduser username<br>
                    psql<br>
                    postgres=# create user username;
    
                    <li>사용자 암호 설정</li>
                    postgres=# \password username<br>
                    또는<br>
                    postgres=# alter user username with password 'new_password';
    
                    <li>DB 생성 후 권한 부여</li>
                    postgres=# create database db_name ENCODING 'UTF-8';<br>
                    postgres=# GRANT ALL PRIVILEGES ON DATABASE db_name TO username;
                </ul>

                <li>psql 명령어</li>
                <ul>
                    <li>db_name=# \l</li>
                    사용 가능한 데이터베이스 리스트
        
                    <li>db_name=# \c db_name</li>
                    데이터베이스 연결
                    
                    <li>db_name=# \dt</li>
                    데이터베이스 테이블 리스트. \dt *account* 처럼 패턴 사용 가능
        
                    <li>db_name=# \d</li>
                    테이블, 뷰 등 리스트. 마찬가지로 패턴 사용 가능
        
                    <li>db_name=# \d name</li>
                    describe table, view, sequence, or index
        
                    <li>db_name=# \o file_name</li>
                    file_name으로 출력
        
                    <li>db_name=# \i file_name</li>
                    file_name 실행
        
                    <li>db_name=# \q</li>
                    접속 종료
                </ul>
            </ol>

            <li>외부 접속 허용</li>
            <ol>
                <li>iptables 규칙 추가</li>
                <ol>
                    /etc/sysconfig/iptables <a role="button" target="_blank" class="btn btn-info btn-sm" href="https://webdir.tistory.com/170">https://webdir.tistory.com/170</a>

                    <li>규칙 추가</li>
                    PostgreSQL 서버의 포트(--dport 5432)로 들어오는(INPUT) tcp 패킷(-p tcp)을 허용(ACCEPT)하는 규칙을 추가(-A). <strong>규칙의 순서가 중요하므로, 앞선 규칙에서 패킷이 폐기되지 않도록 주의</strong><br>
                    $ iptables -A INPUT -p tcp --dport 5432 -j ACCEPT

                    <li>확인</li>
                    $ iptables -nL --line-numbers

                    <li>iptable 재시작</li>
                    $ service iptables restart
                </ol>

                <li>/home/postgres/pgsql/data/postgres.conf 수정</li>
                변경 전 : listen_addresses='localhost'<br>
                변경 후 : listen_addresses='*'<br>
                변경 전 : #port=5432<br>
                변경 후 : port=5432

                <li>/home/postgres/pgsql/data/pg_hba.conf</li>
                보통 서브넷을 특정 : 192.168.0.0/24<br>
                전체 접근 가능 : 0.0.0.0/0<br>
                + host all all 0.0.0.0/0 md5 : 모든 네트워크에 대해 MD5방식 로그인 요구<br>
                + host all all 0.0.0.0/0 trust : 암호 요구 없이 접속 허용.<br>
                + local all all md5 : 로컬 서버에서도 암호를 이용해 접속하도록 변경

                <li>PostgreSQL 서버 restart</li>
            </ol>

            <li>백업</li>
            $ pg_dump -U [소유주] [DB명] -t [테이블 명] &gt; [백업 파일명] // 테이블 백업<br>
            $ pg_dump -U [소유주] [DB명] &gt; [백업 파일명] // DB 백업

            <li>복구</li>
            $ pgsql -U [DB 사용자 명] -f [백업 파일명] [DB명] // 테이블 복구<br>
            $ psql -U [소유주] [DB명] &lt; [백업 파일명] // DB 복구

        </ul>
    </details>
</details>

<hr>

<details>
    <summary>SQL 언어</summary>
    <details>
        <summary>개념</summary>
        클러스터 : 하나의 서버가 관리하는 데이터베이스 집합 단위
    </details>

    <details>
        <summary>테이블 생성, 삭제</summary>
        <ul>
            <li>생성</li>
            CREATE TABLE t_account (<br>
            　　account_id bigint NOT NULL,<br>
            　　lv integer NOT NULL,<br>
            　　nickname text NOT NULL,<br>
            　　start_game_date timestamp with time zone NOT NULL
            );

            <li>psql 안에서 각 명령은 ;로 끝나야 한다.</li>
            
            <li>-- : 한 줄 주석</li>

            <li>복사</li>
            create table t_account_0 ( like t_account including all );
            
            <li>삭제</li>
            DROP TABLE table_name;
        </ul>
    </details>

    <details>
        <summary>테이블에 자료 입력하기</summary>
        <ul>
            <li>숫자가 아닌 자료형은 ‘’안에 적는다.</li>

            <li>INSERT INTO weather VALUES (‘San Francisco’, 46, 50, 0.25, ‘1994-11-27’);</li>

            <li>INSERT INTO weather (city, temp_lo, temp_hi, prcp, date) VALUES ('San Francisco', 43, 57, 0.0, '1994-11-29');</li>

            <li>insert into t_account_old select * from t_account_0;</li>

            <li>COPY weather FROM ‘/home/user/weather.txt;</li>

            <li>COPY t_account_0 (account_id, lv, nickname, start_game_date) FROM stdin;<br>
            1	1	'test'	2017-03-31 12:06:06.446+09<br></li>
            2	2	'test2'	2017-03-31 12:06:06.446+09<br>
            \.</li>
        </ul>
    </details>

    <details>
        <summary>테이블에 있는 자료 조회하기</summary>
        <ul>
            <li>SELECT * FROM weather;</li>
            <li>SELECT city, (temp_hi+temp_lo)/2 AS temp_avg FROM weather;</li>
            <li>SELECT * FROM weather WHERE city = ‘San Francisco’ AND prop &gt; 0.0;</li>
            <li>SELECT * FROM weather ORDER BY city, temp_lo;</li>
            <li>SELECT DISTINCT city FROM weather;</li>

            <li>Cartesian product 연산</li>
            SELECT * FROM weather w, cities c WHERE w.city = c.name;<br>
            SELECT weather.city, cities.location FROM weather, cities WHERE cities.name = weather.city;

            <li>SELECT * FROM weather INNER JOIN cities ON (weather.city = cities.name);</li>

            <li>SELECT * FROM weather LEFT OUTER JOIN cities ON (weather.city = cities.name);</li>
            LEFT OUTER JOIN : 왼쪽 릴레이션 기준으로, 오른쪽 릴레이션에 만족하는 것이 없으면 null로 채운다. + RIGHT OUTER JOIN, FULL OUTER JOIN

            <li>SELF JOIN : 자기 자신과의 조인</li>
            SELECT w1.city, w1.temp_lo AS low, w2.city, w2.temp_lo AS low FROM weather w1, weather w2 WHERE w1.temp_lo &lt; w2.temp_lo;
        </ul>
    </details>
 
    <details>
        <summary>집계 함수</summary>
        <ul>
            <li>SELECT max(temp_lo) FROM weather;</li>
            <li>SELECT city FROM weather WHERE temp_lo = (SELECT max(temp_lo) FROM weather);</li>
            <li>SELECT city, max(temp_lo) FROM weather GROUP BY city;</li>
            <li>SELECT city, max(temp_lo) FROM weather GROUP BY city HAVING max(temp_lo) &lt; 40;</li>
            <li>SELECT city, max(temp_lo) FROM weather WHERE city LIKE ’S%’ GROUP BY city;</li>                
        </ul>
    </details>

    <details>
        <summary>자료 갱신</summary>
        UPDATE weather SET temp_hi = temp_hi - 2, temp_lo = temp_lo - 2 WHERE date &gt; ‘1994-11-28’;
    </details>

    <details>
        <summary>자료 삭제</summary>
        DELETE FROM weather WHERE city = ‘Hayward’;<br>
        DELETE FROM weather;
    </details>
</details>

<hr>

<details>
    <summary>고급 기능</summary>
    <details>
        <summary>뷰</summary>
        CREATE VIEW myview AS SELECT city, temp_lo, temp_hi, prcp, date, location FROM weather, cities WHERE city = name;
    </details>

    <details>
        <summary>외래키</summary>
        CREATE TABLE cities (<br>
        　　city            varchar(80) primary key,<br>
        　　location        point<br>
        );<br>
        <br>
        CREATE TABLE weather (<br>
        　　city        varchar(80) references cities(city),<br>
        　　temp_lo     int,<br>
        　　temp_hi     int,<br>
        　　prcp        real,<br>
        　　date        date<br>
        );
    </details>

    <details>
        <summary>트랜잭션</summary>
        <ul>
            <li>트랜잭션의 시작과 끝은 BEGIN, COMMIT으로 구분하며, 이를 생략한 각 쿼리는 자동으로 감싸진다. 일부 클라이언트 라이브러리는 자동으로 BEGIN, COMMIT 명령을 포함하여, 사용자가 트랜잭션을 지정하면 오류를 내는 경우도 있다.</li>
            <li>ROLLBACK : 도중에 문제가 생겨 지금까지 작업한 내역을 모두 취소하고 트랜잭션 종료</li>
            <li>SAVEPOINT : 중간 지점 설정. 한 중간 지점으로 회귀할 경우, 그 이후의 중간 지점은 모두 사라진다.</li>

            BEGIN;<br>
            UPDATE accounts SET balance = balance - 100 WHERE name = 'Alice';<br>
            SAVEPOINT my_savepoint;<br>
            UPDATE accounts SET balance = balance + 100 WHERE name = 'Bob';<br>
            -- ... Wally한테 가야하는 건데...<br>
            ROLLBACK TO my_savepoint;<br>
            UPDATE accounts SET balance = balance + 100 WHERE name = 'Wally';<br>
            COMMIT;
    </details>

    <details>
        <summary>윈도우 함수</summary>
        <ul>
            <li>행 집합을 대상으로 계산하는 함수. 집계 함수는 행 집합에 대한 하나의 행으로 결과를 보여주지만, 윈도우 함수는 각 행 단위로 결과를 출력한다.</li>
            
            <li>윈도우 함수 뒤에는 항상 OVER 절을 사용한다. OVER 절은 윈도우 함수의 대상이 되는 행 집합을 규정한다.</li>
            
            <li>PARTITION BY는 그룹을 정의한다. 이를 생략할 경우 전체 행이 하나의 그룹으로 취급된다.</li>
            예. 부서별 평균 임금과 각 직원의 급여 비교<br>
            SELECT depname, empno, salary, avg(salary) OVER (PARTITION BY depname) FROM empsalary;

            <li>ORDER BY로 그룹 내 정렬 순서를 지정할 수 있다.</li>
            SELECT depname, empno, salary, rank() OVER (PARTITION BY depname ORDER BY salary DESC) FROM empsalary;

            <li>윈도우 프레임 : 현재 윈도우 함수가 처리하는 행집합. 많은 윈도우 함수들이 윈도우 프레임 단위로 계산한다.</li>
            예. ORDER BY로 인한 윈도우 프레임 차이<br>
            SELECT salary, sum(salary) OVER () FROM empsalary;<br>
            SELECT salary, sum(salary) OVER (ORDER BY salary) FROM empsalary;

            <li>윈도우 함수의 처리 대상은 미리 결정되어야 한다.</li>
            SELECT 항목 영역 안에서와 ORDER BY 절에서만 사용할 수 있다.
            
            <li>집계 함수의 결과를 윈도우 함수의 입력으로 사용할 수는 있지만 그 반대는 불가능하다.</li>

            <li>윈도우 함수의 결과에 대한 검색, 재집계가 필요하다면 서브 쿼리를 사용한다.</li>
            예. 각 부서에서 최상위 3명 임금만 출력<br>
            SELECT depname, empno, salary, enroll_date FROM (<br>
            　　SELECT depname, empno, salary, enroll_date, rank()<br>
            　　　　OVER (PARTITION BY depname ORDER BY salary DESC, empno) AS pos FROM empsalary<br>
            ) AS ss WHERE pos &lt;= 3;<br>
            -- rank 함수의 대상은 OVER에서 특정되므로 생략되었다.

            <li>같은 윈도우 프레임을 이용하는 경우, alias를 이용할 수 있다.</li>
            SELECT sum(salary) OVER w, avg(salary) OVER w FROM empsalary WINDOW w AS (PARITION BY depname ORDER BY salary DESC);
    </details>

    <details>
        <summary>상속</summary>
        <ul>
            <li>객체지향 데이터베이스에서 사용하는 개념. 테이블을 상속하면 해당 테이블의 모든 열을 갖게된다. 다중 상속이 가능하다.</li>
            예. 도시 - 수도<br>
            CREATE TABLE cities (<br>
            　　name        text,<br>
            　　population  real,<br>
            　　altitude    int -- (피트 단위)<br>
            );<br>
            CREATE TABLE capitals (<br>
            　　state       char(2)<br>
            ) INHERITS (cities);
            
            <li>테이블을 조회할 경우, 모든 하위 테이블도 대상이 되며, 해당 테이블만 조회하려면 ONLY 키워드를 이용한다.</li>
            예. 수도를 빼고 도시 고도 500ft 초과의 도시 검색.<br>
            SELECT name, altitude FROM ONLY cities WHERE altitude &gt; 500;
        </ul>
    </details>
</details>

<hr>