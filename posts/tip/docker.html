<hr>

<details>
    <summary>시작하기</summary>
    <ol>
        <li>도커 엔진(Apache 2.0 license)은 REST API로 통신하는 서버-클라이언트로 구성된다</li>
        <li>Docker daemon</li>
        도커 서버는 오랫동안 실행되는 dockerd 데몬 프로세스로, Docker object들을 관리한다
        <li>Docker client</li>
        CLI 클라이언트로 docker 커맨드가 사용된다. 도커 서버, 클라이언트는 서로 별개의 호스트에서 작동할 수 있다
        <li>Docker registry</li>
        이미지 저장소. <a role="button" target="_blank" class="btn btn-info btn-sm" href="https://hub.docker.com/">Docker Hub</a>는 누구나 이용할 수 있는 퍼블릭 레지스트리로, 도커에서 기본적으로 검색하는 저장소다<br>
        Private registry 생성 : docker service create --name registry -p 5000:5000 registry
        <li>Docker object</li>
        IMAGE : 컨테이너를 작성하는 절차를 담은 읽기 전용 템플릿<br>
        CONTAINER : 실행 가능한 IMAGE 인스턴스<br>
        <a role="button" target="_blank" class="btn btn-info btn-sm" href="https://docs.docker.com/engine/reference/builder/">Dockerfile</a> : 이미지 빌드 절차
    </ol>
</details>

<hr>

<details>
    <summary>Dockerfile</summary>
    <ul>
        <li>Format</li>
        <ul>
            <li># 주석</li>
            <li>INSTRUCTION param...</li>
            INSTRUCTION은 대소문자 구별이 없지만, 관례적으로 대문자만 사용한다
        </ul>

        <li>Directive</li>
        <ul>
            <li># directive=value 형태의 특별한 주석</li>
            directive가 아닌 줄을 읽으면 더 이상 directive를 찾지 않으므로, Dockerfile의 최상단에 있어야 한다.
            <li># syntax=[remote image reference]</li>
            Buildkit을 이용하는 경우 유효
            <li># escape=`</li>
            기본값은 \
        </ul>

        <li>환경 변수</li>
        <ul>
            <li>환경 변수 참조1 : $var_name 또는 ${var_name}</li>
            <li>환경 변수 참조2 : ${var_name:-word}</li>
            환경 변수가 없다면 word가 사용된다. word는 임의의 문자열이며, 다른 환경변수를 포함할 수도 있다
            <li>환경 변수 참조3 : ${var_name:+word}</li>
            환경 변수가 있다면 word가 사용된다. 없으면 빈 문자열. word는 임의의 문자열이며, 다른 환경변수를 포함할 수도 있다
            <li>환경 변수 설정 : ENV key=value 또는 ENV key value</li>
            <li>환경 변수 지원 명령어 : ADD, COPY, ENV, EXPOSE, FROM, LABEL, STOPSIGNAL, USER, VOLUME, WORKDIR, ONBUILD(Since 1.4)</li>
        </ul>
        
        <li>FROM</li>
        <ul>
            <li>FROM &lt;image&gt;[:&lt;tag&gt;] [AS &lt;name&gt;]</li>
            <li>FROM &lt;image&gt;[@&lt;digest&gt;] [AS &lt;name&gt;]</li>
            <li>한 Dockerfile 내에서 FROM을 여러 번 사용할 수 있다 : 여러 중간 이미지 + 최종 이미지</li>
        </ul>

        <li>RUN</li>
        <ul>
            <li>RUN &lt;command&gt;</li>
            쉘(기본값 /bin/sh -c, SHELL 명령으로 변경 가능)로 실행. \로 여러 줄 작성 가능
            <li>RUN ["executable", "param1", "param2"]</li>
            JSON 배열로 파싱되어 실행에 이용된다. 반드시 "로 감싸야 하며, \ 이스케이핑에 주의해야 한다
            <li>RUN apt-get update와 apt-get install은 항상 한 번에 실행할 것</li>
            RUN apt-get update &amp;&amp; apt-get install -y \
            　　package-bar \
            　　package-foo=1.3.* \
            <li>RUN rm -rf /var/lib/apt/lists/*, RUN apt-get clean 등으로 캐시를 지워주면 용량에 좋다</li>
        </ul>

        <li>CMD</li>
        <ul>
            <li>CMD ["executable", "param1", "param2"]</li>
            JSON 배열로 파싱되어 실행에 이용된다
            <li>CMD command param1 param2</li>
            쉘로 실행<br>
            <li>CMD의 목적은 컨테이너 실행 시 기본값을 제공하는 것으로, Dockerfile내에서 여러 번 작성됐더라도 마지막 것만 사용된다. 항상 동일하게 실행된다면 ENTRYPOINT 사용을 고려</li>
            docker run 인자로 명시하는 경우, CMD를 오버라이딩한다
        </ul>

        <li>ENTRYPOINT</li>
        <ul>
            <li>ENTRYPOINT ["executable", "param1", "param2"]</li>
            JSON 배열로 파싱되어 실행에 이용된다. CMD는 ENTRYPOINT의 매개변수로 뒤에 덧붙여진다
            <li>ENTRYPOINT command param1 param2</li>
            쉘 실행. CMD directive와 docker run 매개변수를 모두 무시한다. 컨테이너의 실행은 docker exec을 통해 이루어져야 한다.
        </ul>

        <li>LABEL</li>
        <ul>
            <li>LABEL &lt;key&gt;=&lt;value&gt;</li>
            이미지 메타데이터 설정. 공백이 필요하다면 "로 감싸면 된다. LABEL 하나에 여러 값을 설정하는 것은 이미지 크기에 영향을 미치지 않는다(Since 1.10)
        </ul>

        <li>EXPOSE</li>
        <ul>
            <li>EXPOSE &lt;port&gt;[/&lt;protocol&gt;]...</li>
            리스닝하는 포트들을 명시한다(여기서 개방해주는 것이 아님). 프로토콜 기본값은 TCP. 실제 포트를 개방하기 위해서는 docker run에서 -p 옵션으로 포워딩 설정
        </ul>

        <li>ADD</li>
        <ul>
            <li>ADD [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</li>
            <li>ADD [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;",... "&lt;dest&gt;"]</li>
            경로에 공백이 있는 경우 " 이용
            <li>dest로 파일들을 복사한다. 파일명 이스케이핑, 와일드카드 사용은 Go 언어 규칙을 따른다. chown이 주어지지 않으면 UID, GID 모두 0으로 설정된다. 유저와 그룹을 직접 ID로 지정한 경우, /etc/passwd, /etc/group 파일을 조사하지 않는다</li>
            <li>src가 원격지 파일 URL인 경우, 복사된 파일의 권한은 600. 인증이 필요한 경우 wget, crul 등을 이용.</li>
            <li>컨텍스트 안의 파일들만 데몬으로 전송되므로, src는 "../something"처럼 컨텍스트 밖의 파일을 가리킬 수 없다.</li>
            <li>src가 컨텍스트 내의 tar 압축 파일인 경우, 디렉터리로 압축 해제된다</li>
            <li>dest가 존재하지 않는 경우, 모든 필요한 디렉터리를 생성한다</li>
        </ul>

        <li>COPY</li>
        <ul>
            <li>COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;src&gt;... &lt;dest&gt;</li>
            <li>COPY [--chown=&lt;user&gt;:&lt;group&gt;] ["&lt;src&gt;",... "&lt;dest&gt;"]</li>
            경로에 공백이 있는 경우 " 이용
            <li>ADD보다 제한됨 : 컨테이너 내부 파일만 복사 가능. 로컬 tar 자동 압축 해제 X</li>
            중간 이미지로부터 복사 예 : COPY --from=build /bin/project /bin/project
        </ul>

        <li>VOLUME</li>
        <ul>
            <li>예. VOLUME /var/log /var/db</li>
            Mount point를 정의한다. 호스트나 다른 컨테이너에 마운트되어 공유될 수 있다. VOLUME 선언 이후 해당 볼륨 내 변경은 무시된다. Dockerfile 내부에서 마운트될 호스트 디렉터리를 지정할 수는 없다 → 컨테이너 생성 시 지정해야 한다.
        </ul>

        <li>WORKDIR</li>
        <ul>
            <li>예. WORKDIR /path/to/workdir</li>
            RUN, CMD, ENTRYPOINT, COPY, ADD의 작업 디렉터리를 설정한다
        </ul>

        <li>ARG</li>
        <ul>
            <li>ARG &lt;name&gt;[=&lt;default value&gt;]</li>
            docker build --build-arg &lt;varname&gt;=&lt;value&gt;로 넘겨받는 변수를 선언한다. docker history로 넘긴 변수를 볼 수 있으므로, 비밀 정보를 이를 통해 넘기는 건 부적절하다.
            <li>ARG는 빌드 단계에서만 유효하며, 새로운 FROM 이후엔 새로 선언해야 한다</li>
        </ul>

        <li>ONBUILD</li>
        <ul>
            <li>ONBUILD [INSTRUCTION]</li>
            이미지가 베이스로 이용되는 경우, 마치 FROM 이후에 바로 삽입된 것처럼 실행된다
        </ul>

        <li>SHELL</li>
        <ul>
            <li>SHELL ["executable", "param1", "param2"]</li>
            <li>RUN, CMD, ENTRYPOINT 기본 쉘 변경</li>
        </ul>
    </ul>
</details>

<hr>

<details>
    <summary><a role="button" target="_blank" class="btn btn-info btn-sm" href="https://docs.docker.com/engine/reference/commandline/docker/">Commands</a></summary>
    <details>
        <summary>docker build [OPTIONS] PATH | URL | -</summary>
        <ol>
            <li>docker image build [OPTIONS] PATH | URL | -</li>
            <li>향상된 기능을 제공하는 moby/buildkit을 이용하려면(Since 18.09) 실행 전에 환경 변수 DOCKER_BUILDKIT=1를 설정하면 된다</li>
            <li>빌드 과정에서 "컨텍스트"란 지정된 PATH | URL에 존재하는 파일들을 의미한다. 빌드 과정에서 컨텍스트 임의의 파일을 참조할 수 있다</li>
            .dockerignore 파일을 통해 컨텍스트에서 파일/디렉터리들을 제외할 수 있다
            <li>URL은 다음 중 하나가 될 수 있다 : Git 저장소, pre-packaged tarball, plain text file</li>
            <ul>
                <li>docker build https://github.com/docker/rootfs.git#container:docker # container 브랜치의 docker 디렉터리 지정</li>
                Git 저장소를 가리키는 경우, 해당 저장소의 서브모듈까지 재귀적으로 가져온다
                <table>
                    <tbody>
                        <tr><th>Build Syntax Suffix</th><th>Commit Used</th><th>Build Context Used</th></tr>
                        <tr><td>myrepo.git</td><td>refs/heads/master</td><td>/</td></tr>
                        <tr><td>myrepo.git#mytag</td><td>refs/tags/mytag</td><td>/</td></tr>
                        <tr><td>myrepo.git#mybranch</td><td>refs/heads/mybranch</td><td>/</td></tr>
                        <tr><td>myrepo.git#pull/42/head</td><td>refs/pull/42/head</td><td>/</td></tr>
                        <tr><td>myrepo.git#:myfolder</td><td>refs/heads/master</td><td>/myfolder</td></tr>
                        <tr><td>myrepo.git#master:myfolder</td><td>refs/heads/master</td><td>/myfolder</td></tr>
                        <tr><td>myrepo.git#mytag:myfolder</td><td>refs/tags/mytag</td><td>/myfolder</td></tr>
                        <tr><td>myrepo.git#mybranch:myfolder</td><td>refs/heads/mybranch</td><td>/myfolder</td></tr>
                    </tbody>
                </table>
                <li>docker build http://server/context.tar.gz</li>
                표준 tar 포맷이어야 한다. 압축 기법은 xz, bzip2, gzip, identity 중 하나
                <li>docker build - &lt; Dockerfile # STDIN 입력</li>
                curl example.com/remote/Dockerfile | docker build -f - .
            </ul>
            <li>--build-arg : 빌드 환경변수 설정</li>
            <li>--compress : 컨텍스트 gzip 압축</li>
            <li>--disable-content-trust true : 이미지 검증 생략</li>
            <li>--file, -f : Dockerfile 파일명. 기본값은 'PATH/Dockerfile'</li>
            <li>--label : 이미지 메타데이터 설정</li>
            <li>--tag, -t : 이미지 태그 설정</li>
        </ol>
    </details>
    <details>
        <summary>docker commit [OPTIONS] CONTAINER [REPOSITORY[:TAG]]</summary>
        <ol>
            <li>컨테이너의 변경사항이 반영된 새 이미지를 만든다</li>
            <li>--author, -a : 저자</li>
            <li>--change, -c : 새 이미지에 적용할 INSTRUCTION 추가</li>
            docker commit --change "ENV DEBUG true" c3f279d17e0a  svendowideit/testimage:version3
            <li>--message, -m : 커밋 메시지</li>
            <li>--pause, -p : 커밋 도중 컨테이너 일시 정지(default true)</li>
        </ol>
    </details>
    <details>
        <summary>docker tag SOURCE_IMAGE[:TAG] TARGET_IMAGE[:TAG]</summary>
        <ol>
            <li>docker tag 0e5574283393 fedora/httpd:version1.0</li>
            <li>Docker Hub로 올리려는 경우, &lt;Docker Hub Id&gt;/&lt;Repository Name&gt;:&lt;tag&gt;</li>
            docker tag bulletinboard:1.0 gordon/bulletinboard:1.0
            <li>Private repository로 푸시하려면 해당 주소를 붙여줘야 한다</li>
            docker tag 0e5574283393 myregistryhost:5000/fedora/httpd:version1.0
        </ol>
    </details>
    <details>
        <summary>docker push [OPTIONS] NAME[:TAG]</summary>
        <ol>
            <li>docker image push [OPTIONS] NAME[:TAG]</li>
            <li>이미지를 저장소로 업로드한다. 올바른 이미지 태그에 대해서는 docker tag 명령 참고</li>
        </ol>
    </details>
    <details>
        <summary>docker run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]</summary>
        <ol>
            <li>docker container run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]</li>
            <li>새 컨테이너를 만들고(create) 실행(start)한 뒤, 그 안에서 명령을 실행한다</li>
            <li>--publish, -p : 포트 포워딩. -p 80:8080, -p 8888:8080/tcp</li>
            <li>--detach, -d : 지정한 경우 백그라운드 실행. 커맨드가 리턴하면 컨테이너도 종료.</li>
            -d를 지정하지 않은 경우(default) 포그라운드로 실행되며, STDIN, STDOUT, STDERR가 콘솔에 연결된다(default).
            <li>-it : -i(--interactive, STDIN 계속 열어두기) + -t(-tty, Pseudo-tty 할당)</li>
            <li>--name : 컨테이너 이름 할당. 지정하지 않는 경우 docker 데몬이 랜덤하게 할당</li>
            <li>--pid : 기본적으로 각 컨테이너는 별개의 프로세스 네임스페이스에서 실행된다.</li>
            --pid=host, --pid="container:&lt;name|id&gt;"를 이용해 네임스페이스 공유 가능
            <li>--network="" : bridge(default), none, container:&lt;name|id&gt;, host(빠름)</li>
            host : --mac-address 무효<br>
            container : --add-host, --hostname, --dns, --dns-search, --dns-option, --mac-address, --publish, --publish-all, --expose 무효
            <li>--add-host="" : host:IP형식으로 적으면 /etc/hosts에 추가한다</li>
            <li>--ip="", --ip6="", --mac-address="" : 주소 할당</li>
            <li>--restart : no(default), on-failure[:max-retries](0이 아닌 상태로 종료된 경우 재시작), always(항상 재시작), unless-stopped(명시적으로 stop하기 전까지 항상 재시작)</li>
            <li>--rm : 컨테이너 종료 시 삭제</li>
            <li>--memory="", -m : 메모리 제한. 최소 4m</li>
            <li>--stop-timeout : 지정 시간 경과 뒤 종료</li>
            <li>--privileged : 컨테이너에 모든 커널 작업 권한 부여</li>
        </ol>
        <details>
            <summary>Dockerfile 오버라이딩</summary>
            <ol>
                <li>CMD : docker run [OPTIONS] IMAGE[:TAG|@DIGEST] [COMMAND] [ARG...]</li>
                <li>ENTRYPOINT : --entrypoint=""</li>
                --entrypoint /bin/bash example/redis -c ls -l
                <li>EXPOSE(incoming port) : --expose=[]</li>
                <li>ENV : -e, --env, --env-file</li>
                -e "deep=purple" -e today # 값을 지정하지 않으면 현재 값이 전파된다
                <li>VOLUME : -v, --volume=[host-src:]container-dest[:&lt;options&gt;]</li>
                <li>USER : -u="", --user=""</li>
                <li>WORKDIR : -w=""</li>
            </ol>
        </details>
    </details>
    <details>
        <summary>docker rm [OPTIONS] CONTAINER [CONTAINER...]</summary>
        <ol>
            <li>docker container rm [OPTIONS] CONTAINER [CONTAINER...]</li>
            <li>도커 컨테이너 제거</li>
            docker rm $(docker ps -a -q) # 중지한 모든 컨테이너 제거
            <li>--force, -f : 실행 중인 컨테이너 중지 후 제거</li>
            <li>--link, -l : 링크 제거</li>
            <li>--volumes, -v : 볼륨 제거</li>
        </ol>
    </details>
    <details>
        <summary>파일 복사</summary>
        <ol>
            <li>docker-machine scp</li>
            <strong>docker-machine scp source destination</strong><br>
            예. 파일을 가상 머신으로 복사<br>
            docker-machine scp /root/file.war devvm:/home/docker/<br>
            예. 디렉터리 복사<br>
            docker-machine scp -r /root/directory/ devvm:/home/docker/
    
            <li>docker cp</li>
            <strong>docker cp source destination</strong><br>
            예. 파일을 컨테이너로 복사<br>
            docker cp file.war web:/usr/local/tomcat/webapps/<br>
            예. 디렉터리 복사<br>
            docker cp directory/ web:/root/
        </ol>
    </details>
    <details>
        <summary>docker ps [OPTIONS]</summary>
        <ol>
            <li>컨테이너 리스트</li>
            <li>--all, -a : 실행중이지 않은 컨테이너도 표시</li>
            <li>--filter, -f : 필터링 옵션은 https://docs.docker.com/engine/reference/commandline/ps/#filtering 참고</li>
            <li>--format  : Go 템플릿 포맷. https://docs.docker.com/engine/reference/commandline/ps/#formatting 참고</li>
            docker ps --format "{{.ID}}: {{.Command}}"
            <li>--size, -s : 전체 파일 크기 표시</li>
        </ol>
    </details>
    <details>
        <summary>docker images [OPTIONS] [REPOSITORY[:TAG]]</summary>
        <ol>
            <li>이미지 리스트</li>
            <li>--all, -a : 중간 이미지도 표시</li>
            <li>--digests : Digest 표시</li>
        </ol>
    </details>
    <details>
        <summary>docker start [OPTIONS] CONTAINER [CONTAINER...]</summary>
        docker container start [OPTIONS] CONTAINER [CONTAINER...]와 동일
    </details>
    <details>
        <summary>docker search [OPTIONS] TERM</summary>
        <ol>
            <li>Docker Hub 이미지 검색</li>
            <li>--filter stars=3 : 최소 3성 이상</li>
            <li>--filter "is-official=true" : 공식 이미지만</li>
        </ol>
    </details>
    <details>
        <summary>docker pull [OPTIONS] NAME[:TAG|@DIGEST]</summary>
        <ol>
            <li>저장소로부터 이미지 다운로드</li>
            <li>docker pull ubuntu:14.04</li>
            <li>docker pull ubuntu@sha256:45b23dee08af5e43a7fea6c4cf9c25ccf269ee113168c19722f87876677c5cb2</li>
            <li>docker pull myregistry.local:5000/testing/test-image</li>
        </ol>
    </details>
    <details>
        <summary>docker rmi [OPTIONS] IMAGE [IMAGE...]</summary>
        이미지 제거
    </details>
    <details>
        <summary>docker attach [OPTIONS] CONTAINER</summary>
        <ol>
            <li>docker container attach [OPTIONS] CONTAINER</li>
            <li>STDIN, STDOUT, STDERR를 실행 중인 컨테이너에 연결한다</li>
            <li>--detach-keys : 스트림 연결 해제 키 재설정</li>
            -it 옵션으로 실행중이라면, Ctrl + P, Ctrl + Q로 컨테이너를 정지하지 않고 나올 수 있다
            <li>--no-stdin : STDIN은 연결하지 않음</li>
        </ol>
    </details>
    <details>
        <summary>docker exec [OPTIONS] CONTAINER COMMAND [ARG...]</summary>
        <ol>
            <li>docker container exec [OPTIONS] CONTAINER COMMAND [ARG...]</li>
            <li>컨테이너 안에서 명령을 실행한다</li>
            docker exec -it tomcat /bin/bash
            <li>--detach, -d : 백그라운드로 실행시킨다</li>
            <li>--env, -e : 환경 변수 설정 Since 1.25</li>
            <li>--workdir, -w : 워킹 디렉터리 설정 Since 1.35</li>
        </ol>
    </details>
</details>

<hr>

<details>
    <summary>컨테이너 오케스트레이션</summary>
    <details>
        <summary>Kubernetes; K8s</summary>
        Empty
    </details>
    <details>
        <summary>Swarm</summary>
        <pre>
        docker swarm init
        docker service create --name demo alpine:3.5 ping 1.1.1.1
        docker service ps
        docker service logs demo
        docker service rm demo
        // docker service scale
        </pre>
    </details>
</details>

<hr>