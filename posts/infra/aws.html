<html lang="ko"><head><script id="google-analytics" src="https://www.googletagmanager.com/gtag/js?id=UA-143098403-1" async></script><script>window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-143098403-1');
</script><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="google-site-verification" content="aH-DyzdytYQ0NPHNQFcs5dVoiu5YNs6CEEHYgqDmAFM"><meta name="author" content="Donggi Kim &lt;hi.donggi@gmail.com&gt;"><meta name="keywords" content="AWS"><meta name="description" content="AWS 정리"><title>AWS</title><link id="w3css" rel="stylesheet" href="/source/w3.css"><link id="highlight-style" rel="stylesheet" href="/source/xcode.css"><link id="default-style" rel="stylesheet" href="/source/default.css"><script id="highlight-js" src="/source/highlight.pack.js"></script><script id="default-js" src="/source/default.min.js"></script></head><body><div class="w3-bar-block w3-sidebar w3-animate-left" id="sidebar"><hr><a class="w3-bar-item w3-button" href="javascript:closeSidebar();">Close &times;</a><hr><div id="marker-list"></div><hr><div id="post-list"></div><hr><details class="w3-small file-list" open="open"><summary>LICENSE</summary><ul><li>&copy; <a href="mailto:hi.donggi@gmail.com">Donggi Kim</a> →<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://github.com/Dong-gi/Dong-gi.github.io/blob/master/LICENSE">MIT License</a></li><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://www.w3schools.com/w3css">w3css</a> → No license</li><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://highlightjs.org/">highlight.js</a> →<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://github.com/highlightjs/highlight.js/blob/main/LICENSE">BSD-3-Clause License</a></li><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://github.com/mathjax/MathJax">MathJax</a> →<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://github.com/mathjax/MathJax/blob/master/LICENSE">Apache License 2.0</a></li><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://github.com/davidshimjs/qrcodejs">qrcodejs</a> →<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://github.com/davidshimjs/qrcodejs/blob/master/LICENSE">MIT License</a></li></ul></details><hr></div><article id="main"><div class="w3-bar w3-blue w3-large" id="nav" style="position:-webkit-sticky;position:sticky;top:0px;vertical-align:middle"><button class="w3-bar-item w3-button w3-hover-theme" onclick="toggleSidebar()">&#9776;</button><input class="w3-bar-item" id="query" type="text" placeholder="search" style="max-width:35%"><a class="w3-bar-item w3-button w3-hover-theme" href="/">Home</a></div><div class="w3-padding" id="contents"><h1>참고자료</h1><ul><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/index.html">AWS 공식 문서</a></li><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://explore.skillbuilder.aws/learn">AWS 공식 - Learning Center</a></li><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://aws.amazon.com/ko/architecture/security-identity-compliance/">AWS 공식 - 보안 Best Practice</a></li></ul><h1>Auto Scaling</h1><div><h2>크기 조정 계획</h2><ul><li>크기 조정 계획을 지원하는 서비스들에 대한 auto scaling을 손쉽게 구성할 수 있다<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/ko_kr/autoscaling/application/userguide/integrated-services-list.html">integrated-services-list</a></li><li>Aurora : Aurora DB 클러스터의 읽기 전용 복제본 개수에 관해 설정</li><li>EC2 : EC2 Auto Scaling 그룹의 용량에 관해 설정</li><li>ECS : 태스크 수에 관해 설정</li><li>DynamoDB : 읽기 및 쓰기 용량에 관해 설정</li><li>ElastiCache for Redis : 복제본 개수에 관해 설정</li><li>각 서비스별 사용 가능한 지표가 다르다<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/ko_kr/autoscaling/application/userguide/application-auto-scaling-target-tracking.html">application-auto-scaling-target-tracking</a></li></ul><h2>EC2 Auto Scaling</h2><ul><li>Auto Scailing 그룹의 최소 용량, 원하는 용량, 최대 용량을 지정하여 서비스 처리량 유지</li><li>Auto Scailing 그룹의 인스턴스 수명 주기</li><ul><li>Pending : 신규 인스턴스 시작</li><li>Pending:Wait : autoscaling:EC2_INSTANCE_LAUNCHING 후크가 존재하는 경우 Pending에서 천이됨</li><p>e.g. 새 인스턴스에 CodeDeploy 개정을 자동으로 배포할 수 있다 -- Auto Scailing 그룹을 포함하도록 배포 그룹을 생성하거나 업데이트할 때, CodeDeploy 서비스 역할을 사용하여 Auto Scailing 그룹에 수명 주기 후크를 자동 설치</p><li>Pending:Proceed : 수명 주기 후크 완료 시 천이됨</li><li>InService : 인스턴스 구성 완료</li><li>Terminating : 인스턴스 종료 시작</li><li>Terminating:Wait : autoscaling:EC2_INSTANCE_TERMINATING 후크가 존재하는 경우 Terminating에서 천이됨</li><li>Terminating:Proceed : 수명 주기 후크 완료 시 천이됨</li><li>Terminated : 인스턴스 종료 완료</li></ul><li>인스턴스는 다음 중 하나가 발생할 때까지 InService 상태로 유지된다</li><ul><li>축소 이벤트 발생</li><li>인스턴스를 Standby 상태로 천이</li><li>Auto Scailing 그룹으로부터 분리</li><li>상태 확인 실패 임계 도달</li></ul><li>Standby 상태(대기모드)</li><p>인스턴스가 실행 중인 상태에서 서비스 풀에서 분리</p><li>간편한 모니터링 및 인스턴스 자동 조정 정책(평균 CPU 사용, 인스턴스 당 요청 수, 특정 시간대 등) 지원</li></ul></div><h1>CDK, CloudFormation</h1><div><h2>CloudFormation이란?</h2><ul><li>템플릿에 인프라에 필요한 모든 리소스를 기술하고, 템플릿을 이용해 CloudFormation 스택을 생성하면, 필요한 리소스들을 자동으로 프로비저닝한 후 실행한다</li><li>전체 인프라 복제를 신속히 배포할 때 유용</li><li>템플릿은 JSON 또는 YAML 포맷이어야 한다</li><li>온라인 템플릿 편집기 제공:<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://console.aws.amazon.com/cloudformation/designer">designer</a></li><li>업데이트 배포 가능</li><ol><li>템플릿 내용 또는 입력 파라미터의 변경을 제출하여 변경 집합 생성</li><li>변경 집합의 변경 사항 검토</li><p>계정 할당량, 업데이트를 지원하지 않는 리소스를 변경하려는 경우, 실행 권한이 부족한 경우를 사전에 확인하지 않음에 유의</p><li>변경 집합 시작 : 변경 사항들만 기존 스택에 적용</li></ol></ul><h2>시작하기</h2><p>로컬 MySQL을 사용하는 단일 EC2 인스턴스로 WordPress 서비스 제공하는 샘플 템플릿을 통해 기본적인 사항을 알아본다</p><p><strong>↓yaml</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="yaml">AWSTemplateFormatVersion: '2010-09-09'

Description: 'AWS CloudFormation Sample Template WordPress_Single_Instance: WordPress
  is web software you can use to create a beautiful website or blog. This template
  installs WordPress with a local MySQL database for storage. It demonstrates using
  the AWS CloudFormation bootstrap scripts to deploy WordPress. **WARNING** This template
  creates an Amazon EC2 instance. You will be billed for the AWS resources used if
  you create a stack from this template.'

Parameters:
  DBName:
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric
      characters.
    Default: wordpressdb
    Description: The WordPress database name
    MaxLength: '64'
    MinLength: '1'
    Type: String
  DBPassword:
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
    Description: The WordPress database admin account password
    MaxLength: '41'
    MinLength: '8'
    NoEcho: 'true'
    Type: String
  DBRootPassword:
    AllowedPattern: '[a-zA-Z0-9]*'
    ConstraintDescription: must contain only alphanumeric characters.
    Description: MySQL root password
    MaxLength: '41'
    MinLength: '8'
    NoEcho: 'true'
    Type: String
  DBUser:
    AllowedPattern: '[a-zA-Z][a-zA-Z0-9]*'
    ConstraintDescription: must begin with a letter and contain only alphanumeric
      characters.
    Description: The WordPress database admin account username
    MaxLength: '16'
    MinLength: '1'
    NoEcho: 'true'
    Type: String
  InstanceType:
    AllowedValues:
    - t2.micro
    - t2.small
    ConstraintDescription: must be a valid EC2 instance type.
    Default: t2.small
    Description: WebServer EC2 instance type
    Type: String
  KeyName:
    ConstraintDescription: must be the name of an existing EC2 KeyPair.
    Description: Name of an existing EC2 KeyPair to enable SSH access to the instances
    Type: AWS::EC2::KeyPair::KeyName
  SSHLocation:
    AllowedPattern: (\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})/(\d{1,2})
    ConstraintDescription: must be a valid IP CIDR range of the form x.x.x.x/x.
    Default: 0.0.0.0/0
    Description: The IP address range that can be used to SSH to the EC2 instances
    MaxLength: '18'
    MinLength: '9'
    Type: String

Mappings:
  AWSInstanceType2Arch:
    t2.micro:
      Arch: HVM64
    t2.small:
      Arch: HVM64
  AWSRegionArch2AMI:
    us-east-1:
      HVM64: ami-60b6c60a
      HVMG2: ami-e998ea83
      PV64: ami-5fb8c835
    us-west-1:
      HVM64: ami-d5ea86b5
      HVMG2: ami-943956f4
      PV64: ami-56ea8636

Resources:
  WebServer:
    Type: AWS::EC2::Instance
    CreationPolicy:
      ResourceSignal:
        Timeout: PT15M
    Metadata:
      AWS::CloudFormation::Init:
        configSets:
          wordpress_install:
          - install_cfn
          - install_wordpress
          - configure_wordpress
        configure_wordpress:
          commands:
            01_set_mysql_root_password:
              command: !Sub |
                mysqladmin -u root password '${DBRootPassword}'
              test: !Sub |
                $(mysql ${DBName} -u root --password='${DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? != 0 ))
            02_create_database:
              command: !Sub |
                mysql -u root --password='${DBRootPassword}' &lt; /tmp/setup.mysql
              test: !Sub |
                $(mysql ${DBName} -u root --password='${DBRootPassword}' &gt;/dev/null 2&gt;&amp;1 &lt;/dev/null); (( $? !=0))
            03_configure_wordpress:
              command: /tmp/create-wp-config
              cwd: /var/www/html/wordpress
        install_cfn:
          files:
            /etc/cfn/cfn-hup.conf:
              content: !Sub |
                [main]
                stack= ${AWS::StackId}
                region=${AWS::Region}
              group: root
              mode: '000400'
              owner: root
            /etc/cfn/hooks.d/cfn-auto-reloader.conf:
              content: !Sub |
                [cfn-auto-reloader-hook]
                triggers=post.update
                path=Resources.WebServer.Metadata.AWS::CloudFormation::Init
                action=/opt/aws/bin/cfn-init -v --stack ${AWS::StackName} --resource WebServer --configsets wordpress_install --url https://stackbuilder.amazonaws.com
              group: root
              mode: '000400'
              owner: root
          services:
            sysvinit:
              cfn-hup:
                enabled: true
                ensureRunning: true
                files:
                - /etc/cfn/cfn-hup.conf
                - /etc/cfn/hooks.d/cfn-auto-reloader.conf
        install_wordpress:
          files:
            /tmp/create-wp-config:
              content: !Sub |
                #!/bin/bash -xe
                cp /var/www/html/wordpress/wp-config-sample.php /var/www/html/wordpress/wp-config.php
                sed -i "s/'database_name_here'/'${DBName}'/g" wp-config.php
                sed -i "s/'username_here'/'${DBUser}'/g" wp-config.php
                sed -i "s/'password_here'/'${DBPassword}'/g" wp-config.php
              group: root
              mode: '000500'
              owner: root
            /tmp/setup.mysql:
              content: !Sub |
                CREATE DATABASE ${DBName};
                CREATE USER '${DBUser}'@'localhost' IDENTIFIED BY '${DBPassword}';
                GRANT ALL ON ${DBName}.* TO '${DBUser}'@'localhost';
                FLUSH PRIVILEGES;
              group: root
              mode: '000400'
              owner: root
          packages:
            yum:
              httpd: []
              mysql: []
              mysql-devel: []
              mysql-libs: []
              mysql-server: []
              php: []
              php-mysql: []
          services:
            sysvinit:
              httpd:
                enabled: true
                ensureRunning: true
              mysqld:
                enabled: true
                ensureRunning: true
          sources:
            /var/www/html: http://wordpress.org/latest.tar.gz
    Properties:
      ImageId: !FindInMap [AWSRegionArch2AMI, !Ref 'AWS::Region', !FindInMap [AWSInstanceType2Arch, !Ref InstanceType, Arch]]
      InstanceType:
        Ref: InstanceType
      KeyName:
        Ref: KeyName
      SecurityGroups:
      - Ref: WebServerSecurityGroup
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash -xe
          yum update -y aws-cfn-bootstrap
          /opt/aws/bin/cfn-init -v --stack ${AWS::StackId} --resource WebServer --configsets wordpress_install --region ${AWS::Region}
          /opt/aws/bin/cfn-signal -e $? --stack ${AWS::StackId} --resource WebServer --region ${AWS::Region}
  WebServerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: "Enable HTTP access via port 80 locked down to the load balancer + SSH access"
      SecurityGroupIngress:
      - CidrIp: 0.0.0.0/0
        FromPort: '80'
        IpProtocol: tcp
        ToPort: '80'
      - CidrIp: !Ref SSHLocation
        FromPort: '22'
        IpProtocol: tcp
        ToPort: '22'

Outputs:
  PublicIP:
    Description: EC2 public IP
    Value: !GetAtt WebServer.PublicIp
  WebsiteURL:
    Description: WordPress Website
    Value: !Sub "http://${WebServer.PublicDnsName}/wordpress"
</div><ol><li>샘플은 6개의 최상위 섹션을 갖지만(AWSTemplateFormatVersion, Description, Parameters, Mappings, Resources, Outputs), 이 중 Resources 섹셕만 필수 요소다</li></ol><h2>샘플 템플릿</h2><ul><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/CHAP_TemplateQuickRef.html">서비스별 샘플 템플릿</a></li><li><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/cfn-sample-templates.html">리전별 샘플 템플릿</a></li></ul><h2>CDK(Cloud Development Kit)</h2><p>고급 프로그래밍 언어를 이용해 인프라 작성 > CloudFormation 템플릿 자동 생성 > 스택 배포</p><h3 class="fake">예시 :<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/cdk/v2/guide/hello_world.html">hello_world</a></h3><ol><li>CDK 설치 :<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/cdk/v2/guide/cli.html">cli</a></li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">npm install -g aws-cdk</div><li>앱 생성(JavaScript)</li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">mkdir hello-cdk
cd hello-cdk
cdk init app --language javascript</div><li>^ 정상인지 확인</li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">cdk ls</div><p>HelloCdkStack가 결과에 포함되어야 한다</p><li>서비스 구성요소 추가</li><p><strong>↓lib/hello-cdk-stack.js</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="JavaScript">const cdk = require('aws-cdk-lib');
const s3 = require('aws-cdk-lib/aws-s3');

class HelloCdkStack extends cdk.Stack {
    constructor(scope, id, props) {
        super(scope, id, props);

        new s3.Bucket(
            this,               // Scope
            'MyFirstBucket',    // Id
            {                   // Properties
                versioned: true
            }
        );
    }
}

module.exports = { HelloCdkStack }</div><li>CloudFormation 템플릿 생성</li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">cdk synth</div><p>YAML 포맷의 템플릿이 출력되며, cdk.out 디렉터리에 JSON 포맷 템플릿도 작성된다</p><li>스택 배포</li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">cdk deploy</div><li>스택 정의 업데이트 -- 스택 삭제 시 모든 객체와 버킷을 삭제하도록</li><p><strong>↓lib/hello-cdk-stack.js</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="JavaScript">new s3.Bucket(
    this,               // Scope
    'MyFirstBucket',    // Id
    {                   // Properties
        versioned: true,
        removalPolicy: cdk.RemovalPolicy.DESTROY,
        autoDeleteObjects: true
    }
);</div><li>변경 사항 확인</li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">cdk diff</div><ul><li>객체 자동 삭제를 위해 Lambda 함수가 추가되는 것을 볼 수 있다</li><li>추가적으로 cdk synth의 결과를 비교해보는 것도 유용할 수 있다</li></ul><li>스택 업데이트 배포</li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">cdk deploy</div><li>스택 제거</li><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">cdk destroy</div></ol></div><h1>IAM; Identity and Access Management</h1><div><h2>AWS 계정</h2><ul><li>AWS 계정은 AWS의 기초적인 보안 경계, 리소스 경계, 책임 경계가 된다</li><li>AWS 각 서비스 제한량 역시 AWS 계정을 기준으로 부여할 수 있다</li></ul><h2>AWS Organizations</h2><ul><li>여러 AWS 계정을 조직에 통합하여 중앙에서 관리하는 서비스</li><li>효율적인 조직 비용 관리 가능</li><li>최대 5단계의 OU(조직 그룹) 트리 구성 가능</li><li>조직 관리자가 정의한 제한은 개별 멤버 계정 관리자보다 우선</li></ul><h2>IAM이란?</h2><ul><li>단일 계정 내 인증 및 권한 관리 서비스</li><li>암호나 액세스 키를 공유하지 않고도 권한 부여</li><li>세분화된 권한 관리</li><li>다른 곳에 암호가 있는 사용자에게 임시 액세스 권한 부여</li><li>AWS는 PCI DSS 1 레벨1 서비스 공급자 인증을 받음</li><li>IAM과 STS는 추가 비용 없이 제공됨</li></ul><div><h3>IAM 작동 방식</h3><div><h4 class="fake">Terms</h4><ul><li>IAM 리소스</li><p>사용자, 그룹, 정책, 자격 증명 공급자 객체는 다른 AWS 서비스와 마찬가지로 IAM에서 추가, 편집, 제거 가능한 리소스다</p><li>IAM 자격 증명</li><p>사용자(영구 자격 증명 사용), 그룹, 역할(임시 보안 자격 증명 사용). 식별 및 그룹화에 사용되는 IAM 리소스 객체로, 정책을 이에 연결할 수 있다</p><li>IAM 엔터티</li><p>사용자, 역할. AWS가 인증에 사용하는 IAM 리소스 객체</p><li>보안 주체</li><p>AWS 루트 사용자, IAM 사용자, IAM 역할을 사용하여 AWS에 요청하는 사람 또는 애플리케이션</p><li>최소 권한 원칙</li><p>필요한 경우에만 승격된 권한을 사용하도록 제한</p></ul><h4 class="fake">Request</h4><p>보안 주체가 AWS Management Console, AWS API, AWS CLI를 사용해 전송하는 요청에는 다음의 정보가 포함된다 -- 요청 컨텍스트</p><ul><li>수행하고자 하는 작업</li><li>작업 대상이 되는 AWS 리소스 객체</li><li>요청을 보내는 보안 주체</li><li>환경 데이터 : IP 주소, User agent, SSL 사용 여부 등</li><li>리소스 객체와 연관된 데이터 : EC2 인스턴스 태그 등</li></ul><h4 class="fake">Authorization</h4><p>AWS는 요청 컨텍스트에 적용되는 각 정책을 확인하여, 하나라도 거부되는 경우 전체 요청을 거부하고 평가를 중지한다. 아래는 요청 평가에 대한 일반 규칙</p><ol><li>기본적으로 모든 요청은 거부</li><li>정책에 포함된 명시적 허용은 위 거부를 재정의</li><li>권한 경계 또는 세션 정책이 있는 경우 위 허용을 재정의</li><li>정책의 명시적 거부는 위 허용을 무시</li></ol></div><h3>ABAC란?</h3><ul><li>ABAC(Attribute based access control)는 보안 주체와 리소스의 태그가 일치할 때 권한을 부여한다</li><li>동종 리소스에 대한 동일 작업에 대한 정책 하나만 가지고도 각 보안 주체가 각각 필요한 리소스에만 접근할 수 있게 한다</li></ul></div><h2>IAM 시작하기 > IAM 관리자 및 사용자 그룹 생성</h2><ol><li>루트 사용자로 로그인</li><li>탐색 표시줄 > 내 계정 > 결제 정보에 대한 IAM 사용자 및 역할 액세스 편집 > IAM 액세스 활성</li><p>관리자 사용자가 비용 및 사용량과 상호작용하려면 위 작업 필요</p><li>IAM 콘솔에서 관리자 사용자 추가. 여러 명인 경우 사용자 그룹도 추가</li><li>사용자 또는 사용자 그룹에 AdministratorAccess 정책 연결</li></ol><h2>자습서</h2><div><h3>역할을 사용하여 AWS 계정 간 권한 위임</h3><ol><li>리소스를 가진 계정(A)에서 리소스 액세스 역할 생성</li><p>역할 생성 시, 신뢰할 수 있는 엔터티 유형으로 "다른 AWS 계정" 지정</p><li>권한을 위임받고자 하는 계정(B)에서 적절한 IAM 보안 주체에 AssumeRole 허용 정책 연결</li><p><strong>↓인라인 정책 예</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="json">{
    "Version": "2012-10-17",
    "Statement": {
        "Effect": "Allow",
        "Action": "sts:AssumeRole",
        "Resource": "arn:aws:iam::ACCOUNT-A-ID:role/ROLE-NAME"
    }
}</div><li>역할 전환 테스트</li><ul><li>AWS 콘솔</li><ul><li>역할 전환 시 ExternalId를 요구하지 않아야만 가능</li><li>방법 1 : 역할 생성 시 Role Summary 페이지에서 제공된 url 사용</li><li>방법 2 : 탐색 표시줄 > Switch Role > 계정 ID 또는 alias, 역할 이름 수동 입력</li></ul><li>AWS CLI</li><p><strong>↓aws-cli</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">aws sts assume-role --role-arn "ROLE-ARN" --role-session-name "ARBITRARY-SESSION-NAME"

# 환경 변수로 세션 키 설정
export AWS_ACCESS_KEY_ID="GIVEN-BY-ASSUME-ROLE"
export AWS_SECRET_ACCESS_KEY="GIVEN-BY-ASSUME-ROLE"
export AWS_SESSION_TOKEN="GIVEN-BY-ASSUME-ROLE"</div><li>AWS API</li><p>AssumeRole 호출 응답으로 주어진 임시 자격 증명을 사용하여 API 호출</p></ul></ol><h3>ABAC 사용</h3><ul><li>"access-" 접두사를 가진 역할에 대해, 사용자 태그와 역할 태그가 일치하는 경우 역할 전환할 수 있는 정책 예</li><p><strong>↓json</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "TutorialAssumeRole",
            "Effect": "Allow",
            "Action": "sts:AssumeRole",
            "Resource": "arn:aws:iam::ACCOUNT-ID:role/access-*",
            "Condition": {
                "StringEquals": {
                    "iam:ResourceTag/team": "${aws:PrincipalTag/team}",
                    "iam:ResourceTag/project": "${aws:PrincipalTag/project}"
                }
            }
        }
    ]
}</div><li>SAML 세션 태그를 이용해 역할 전환하는 정책 예</li><p><strong>↓json</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllowSamlIdentityAssumeRole",
            "Effect": "Allow",
            "Action": [
                "sts:AssumeRoleWithSAML",
                "sts:TagSession"
            ],
            "Principal": {
                "Federated": "arn:aws:iam::123456789012:saml-provider/ExampleCorpProvider"
            },
            "Condition": {
                "StringLike": {
                    "aws:RequestTag/team": [
                        "engineer",
                        "qa"
                    ],
                    "aws:RequestTag/project": "*"
                },
                "StringEquals": {
                    "SAML:aud": "https://signin.aws.amazon.com/saml"
                }
            }
        }
    ]
}</div><li>보안 주체 태그와 리소스 태그가 일치하는 경우 권한을 인가하는 정책 예</li><p><strong>↓json</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "AllActionsSecretsManagerSameProjectSameTeam",
            "Effect": "Allow",
            "Action": "secretsmanager:*",
            "Resource": "*",
            "Condition": {
                "StringEquals": {
                    "aws:ResourceTag/team": "${aws:PrincipalTag/team}",
                    "aws:ResourceTag/project": "${aws:PrincipalTag/project}"
                }
            }
        }
    ]
}</div><li>ABAC로 권한을 부여받은 보안 주체가 태그 및 리소스 기반 정책을 변경하지 못하도록 하는 정책 예</li><p><strong>↓json</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "DenyUntagSecretsManagerReservedTags",
            "Effect": "Deny",
            "Action": "secretsmanager:UntagResource",
            "Resource": "*",
            "Condition": {
                "ForAnyValue:StringLike": {
                    "aws:TagKeys": "*"
                }
            }
        },
        {
            "Sid": "DenyPermissionsManagement",
            "Effect": "Deny",
            "Action": "secretsmanager:*Policy",
            "Resource": "*"
        }
    ]
}
</div></ul></div><h2>ID</h2><div><h3>Roles</h3><div><h4 class="fake">역할을 사용할 수 있는 주체</h4><ul><li>동일한 AWS 계정의 IAM 사용자</li><li>다른 AWS 계정의 IAM 사용자</li><li>AWS 서비스(EC2 등)</li><li>SAML 2.0, OpenID Connect 등 외부 자격 증명 공급자(IdP)에 의해 인증된 외부 사용자</li></ul><h4 class="fake">EC2 애플리케이션에서 역할 사용</h4><p>EC2 인스턴스에 IAM 역할을 할당하면 장기 자격 증명을 인스턴스에 배포하지 않아도 된다. 예를 들어, AWS Java SDK에서 인증 정보 없이 서비스 클라이언트 인스턴스 생성 시 DefaultAWSCredentialsProviderChain에 정의된 순서대로 인증 정보를 조회한다</p><ol><li>환경 변수 : AWS_ACCESS_KEY, AWS_SECRET_KEY</li><p>Java SDK 외의 경우엔 AWS_ACCESS_KEY_ID, AWS_SECRET_ACCESS_KEY</p><li>Java System Properties : aws.accessKeyId, aws.secretKey</li><li>Web Identity Token credential</li><li>Credential profile : ~/.aws/credentials</li><li>Amazon EC2 container service로 전달되는 인증 정보</li><li>Amazon EC2 metadata service로 전달되는 인증 정보</li></ol><p>인스턴스 내부에서 aws cli를 직접 실행하는 경우엔 얘기가 다르다. profile을 추가로 지정해야 하고, 해당 profile로 assume role할 수 있는 권한이 있어야 한다</p></div><span id="pos1453283971" style="padding:0!important;margin:0!important;width:0!important;height:0!important;overflow:hidden!important"></span><h3>CloudTrail을 사용하여 이벤트 로깅</h3><ul><li>CloudTrail은 IAM, STS 호출을 이벤트로 캡처한다</li><li>글로벌 리전 서비스가 아닌 경우, 이벤트는 한 리전에만 로깅된다</li><li>추적을 생성하면 이벤트를 S3 버킷으로 배포할 수 있다</li><li>추적을 생성하지 않아도 Event history에서 90일 간의 기록을 무료로 확인 가능</li></ul><div><h4 class="fake">CloudTrail 이벤트</h4><ul><li>관리 이벤트 : 관리 작업에 대한 정보</li><p>e.g. 보안 구성, 로깅 설정 등</p><li>데이터 이벤트 : 리소스 작업에 대한 정보</li><p>e.g. 버킷 및 객체 수준 API, Lambda 실행, DynamoDB 객체 수준 API</p><li>Insignts 이벤트 : 비정상적인 API 호출 비율, 오류 비율 캡처</li></ul></div></div><h2>액세스 관리</h2><div><h3>정책 및 권한</h3><div><h4 class="fake">정책 유형</h4><ul><li>자격 증명 기반 정책 : 관리형 및 인라인 정책을 보안 주체에 연결</li><li>리소스 기반 정책 : 인라인 정책을 리소스에 연결. e.g. S3 버킷 정책, IAM 역할 신뢰 정책</li><li>권한 경계 : 부여할 수 있는 최대 권한 정의</li><li>Organizations SCP : 조직 단위 계정 멤버에 대한 최대 권한 정의</li><li>ACL : JSON 정책 문서 구조를 사용하지 않고, 액세스할 수 있는 보안 주체 목록으로 제어</li><li>세션 정책 : 역할 또는 페더레이션 사용자에 대해 임시 세션을 프로그래밍 방식으로 생성할 때 파라미터로 전달하는 고급 정책</li></ul><h4 class="fake">JSON 정책 언어 문법(2012-10-17)</h4><p><strong>↓text</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="text">policy  = {
    &lt;version_block?&gt;
    &lt;id_block?&gt;
    &lt;statement_block&gt;
}

&lt;version_block&gt; = "Version" : ("2008-10-17" | "2012-10-17")

&lt;id_block&gt; = "Id" : &lt;policy_id_string&gt;

&lt;statement_block&gt; = "Statement" : [ &lt;statement&gt;, &lt;statement&gt;, ... ]

&lt;statement&gt; = {
    &lt;sid_block?&gt;,
    &lt;principal_block?&gt;,
    &lt;effect_block&gt;,
    &lt;action_block&gt;,
    &lt;resource_block&gt;,
    &lt;condition_block?&gt;
}

&lt;sid_block&gt; = "Sid" : &lt;sid_string&gt;

&lt;effect_block&gt; = "Effect" : ("Allow" | "Deny")

&lt;principal_block&gt; = ("Principal" | "NotPrincipal") : ("*" | &lt;principal_map&gt;)

&lt;principal_map&gt; = { &lt;principal_map_entry&gt;, &lt;principal_map_entry&gt;, ... }

&lt;principal_map_entry&gt; = ("AWS" | "Federated" | "Service" | "CanonicalUser") :
    [&lt;principal_id_string&gt;, &lt;principal_id_string&gt;, ...]

&lt;action_block&gt; = ("Action" | "NotAction") :
    ("*" | [&lt;action_string&gt;, &lt;action_string&gt;, ...])

&lt;resource_block&gt; = ("Resource" | "NotResource") :
    ("*" | [&lt;resource_string&gt;, &lt;resource_string&gt;, ...])

&lt;condition_block&gt; = "Condition" : { &lt;condition_map&gt; }
&lt;condition_map&gt; = {
    &lt;condition_type_string&gt; : { &lt;condition_key_string&gt; : &lt;condition_value_list&gt; },
    &lt;condition_type_string&gt; : { &lt;condition_key_string&gt; : &lt;condition_value_list&gt; }, ...
}
&lt;condition_value_list&gt; = [&lt;condition_value&gt;, &lt;condition_value&gt;, ...]
&lt;condition_value&gt; = ("string" | "number" | "Boolean")</div><ul><li>Version : 정책 언어 버전</li><li>Id : 정책 식별자</li><li>Statement : 1개 이상의 세부 정책</li><li>Sid : 세부 정책 식별자. API에서 참조되는 값이 아니며, 정책에 대한 서술을 적어도 좋다</li><li>Effect : 세부 정책이 허가/거부를 나타내는 지 여부</li><li>Principal : 리소스 기반 JSON 정책에서, 허가/거부의 대상이 될 보안 주체 지정</li><li>NotPrincipal : Principal과 반대로, 여집합을 지정</li><p>"Effect": "Deny"와 함께, 지정한 보안 주체를 제외한 모든 보안 주체에 대해 명시적으로 거부하는 드문 경우에 사용</p><li>Action : 대상 작업 목록. 작업 이름은 대소문자 구별 없음. 와일드카드 * 가능</li><li>NotAction : Action과 반대로, 여집합을 지정</li><li>Resource : 대상 리소스 ARN 목록. 와일드카드 *, ? 가능</li><li>NotResource : Resource와 반대로, 여집합을 지정</li><li>Condition : 요청 컨텍스트에 대한 추가 조건 연산</li></ul><h4 class="fake">정책 조건 연산</h4><ul><li>조건 키는 대소문자 구별 없음. aws:ResourceTag/<i class="w3-red">tag-key</i>처럼 키 일부를 사용자가 지정할 수 있는 경우에도 마찬가지로 대소문자 구별 없음에 유의</li><p>조건 키로 다음 2가지가 가능:<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/reference_policies_condition-keys.html">전역 조건 키</a>,<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/ko_kr/service-authorization/latest/reference/reference_policies_actions-resources-contextkeys.html#context_keys_table">서비스별 조건 키</a></p><li>각 조건 키의 평가 결과는 다음 중 하나 : true, false, not present, null(빈 문자열)</li><li>조건 연산자</li><table class="no-sort"><tr><th>연산자</th><th>설명</th><th>대응 Not 연산자</th></tr><tr><td>문자열 조건 연산자</td><td>정책 변수 사용 가능</td><td></td></tr><tr><td>StringEquals</td><td>대소문자 구별한 문자열 일치</td><td>StringNotEquals</td></tr><tr><td>StringEqualsIgnoreCase</td><td>대소문자 무시한 문자열 일치</td><td>StringNotEqualsIgnoreCase</td></tr><tr><td>StringLike</td><td>대소문자 구별한 문자열 일치. 와일드카드 *, ? 허용</td><td>StringNotLike</td></tr><tr><td>숫자 조건 연산자</td><td>정책 변수 사용 불가. 정수 또는 십진수 비교</td><td></td></tr><tr><td>NumericEquals</td><td>일치</td><td>NumericNotEquals</td></tr><tr><td>NumericLessThan</td><td>미만</td><td>NumericGreaterThanEquals</td></tr><tr><td>NumericLessThanEquals</td><td>이하</td><td>NumericGreaterThan</td></tr><tr><td>날짜 조건 연산자</td><td>정책 변수 사용 불가. ISO 8601 포맷 또는 UNIX epoch 비교</td><td></td></tr><tr><td>DateEquals</td><td>일치</td><td>DateNotEquals</td></tr><tr><td>DateLessThan</td><td>미만</td><td>DateGreaterThanEquals</td></tr><tr><td>DateLessThanEquals</td><td>이하</td><td>DateGreaterThan</td></tr><tr><td>부울 조건 연산자</td><td>정책 변수 사용 불가. 키를 &quot;true&quot; 또는 &quot;false&quot;와 비교</td><td></td></tr><tr><td>Bool</td><td>일치</td><td></td></tr><tr><td>이진 조건 연산자</td><td>정책 변수 사용 불가</td><td></td></tr><tr><td>BinaryEquals</td><td>지정한 Base64 인코딩 표시와 바이트 단위로 일치</td><td></td></tr><tr><td>IP 주소 조건 연산자</td><td>정책 변수 사용 불가</td><td></td></tr><tr><td>IpAddress</td><td>지정 CIDR에 포함</td><td>NotIpAddress</td></tr><tr><td>ARN 조건 연산자</td><td>정책 변수 사용 가능. ARN의 콜론으로 구분된 6개 구성요소 각각 별도로 확인한다</td><td></td></tr><tr><td>ArnEquals, ArnLike</td><td>대소문자 구별한 ARN 일치. 와일드카드 *, ? 허용</td><td>ArnNotEquals, ArnNotLike</td></tr><tr><td>…IfExists 조건 연산자</td><td>Null을 제외한 조건 연산자 이름 끝에 IfExists를 추가하면 요청 컨텍스트에 정책 키가 없으면 true로 평가</td><td></td></tr><tr><td>Null</td><td>정책 변수 사용 불가. 조건 키의 유무 검사</td><td></td></tr></table><li>한 정책에 다수의 조건 연산자가 있는 경우 : AND 평가</li><li>한 조건 연산자에 다수의 키가 추가된 경우 : AND 평가</li><li>한 조건 키에 다수의 값이 포함된 경우 : OR 평가</li><li>값 자체가 다중인 경우, 조건 집합 연산자를 사용할 수 있다</li><ul><li>ForAllValues : 요청 컨텍스트의 값 집합이 지정한 조건 키 집합의 부분집합</li><li>ForAnyValue : 요청 컨텍스트의 값 집합 원소 중 하나라도 지정한 조건 키 집합의 원소</li><p><strong>↓text</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="text">"Condition": {
    "ForAnyValue:StringEquals": {
        "dynamodb:Attributes": [ "ID", "Message" ]
    }
}
</div></ul><li>정책 변수 및 태그</li><ul><li>Resource 요소에서의 사용 : ARN의 5번째 콜론 뒷부분만</li><p><strong>↓text</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="text">"Resource": ["arn:aws:s3:::bucket/${aws:PrincipalTag/department}"]</div><li>Condition 요소에서의 사용 : 허용되는 조건 연산자에서만</li><p><strong>↓text</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="text">"Condition": {
    "StringLike": {
        "iam:ResourceTag/costCenter": [ "12345", "67890" ]
    }
}</div><li>모든 요청에 사용할 수 있는 정보</li><table><tr><td>aws:CurrentTime</td><td>현재 시각</td></tr><tr><td>aws:EpochTime</td><td>현재 시각</td></tr><tr><td>aws:TokenIssueTime</td><td>임시 보안 자격 증명 발급 시각</td></tr><tr><td>aws:PrincipalType</td><td>보안 주체 종류 : Account, User, FederatedUser, AssumedRole, Anonymous(S3, SNS, SQS)</td></tr><tr><td>aws:SecureTransport</td><td>SSL 요청인지 여부</td></tr><tr><td>aws:SourceIp</td><td>요청자 IP</td></tr><tr><td>aws:UserAgent</td><td>신뢰성이 떨어지는 클라이언트 정보</td></tr><tr><td>aws:userid</td><td>보안 주체 고유 ID</td></tr><tr><td>aws:username</td><td>IAM 사용자 이름</td></tr><tr><td>ec2:SourceInstanceARN</td><td>EC2에 할당된 IAM 역할을 이용해 들어온 요청인 경우 인스턴스 ARN이 설정됨</td></tr></table><li>서비스별 정보</li><p>s3:prefix, s3:max-keys, s3:x-amz-acl, sns:Endpoint, sns:Protocol, ...</p><li>특수 문자 리터럴 표현</li><ul><li>${*} : 문자 * 표현</li><li>${?} : 문자 ? 표현</li><li>${$} : 문자 $ 표현</li></ul><li>변수가 없는 경우 사용할 기본값 제공</li><p><strong>↓text</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="text">"Resource":"arn:aws:s3:::DOC-EXAMPLE-BUCKET-${aws:PrincipalTag/team, 'company-wide'}"</div></ul></ul><h4 class="fake"><a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/ko_kr/IAM/latest/UserGuide/access_policies_examples.html">정책 예제</a></h4><ul><li>MFA 설정 허용 정책</li><p><strong>↓json</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="json">{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "VisualEditor0",
            "Effect": "Allow",
            "Action": [
                "iam:DeactivateMFADevice",
                "iam:DeleteVirtualMFADevice",
                "iam:EnableMFADevice",
                "iam:ResyncMFADevice",
                "iam:CreateVirtualMFADevice",
                "iam:ListMFADevices"
            ],
            "Resource": [
                "arn:aws:iam::123456789012:mfa/${aws:username}",
                "arn:aws:iam::123456789012:user/${aws:username}"
            ]
        },
        {
            "Sid": "VisualEditor1",
            "Effect": "Allow",
            "Action": "iam:ListVirtualMFADevices",
            "Resource": "*"
        }
    ]
}
</div></ul></div></div><h2>액세스 분석기</h2><p>IAM Access Analyzer는 외부 엔터티와 공유되는 조직 및 계정 내 리소스를 식별하여 액세스가 의도한 액세스인지, 의도하지 않은 보안 위험인지 확인할 수 있다. 모든 상용 AWS 리전에서 무료로 IAM 콘솔 및 API를 통해 이용 가능</p></div><h1>WAF, Firewall Manager, Shield</h1><div><h2>개요</h2><ul><li>WAF(Web application firewall)</li><p>규칙(e.g. 시간-IP당 요청 수)을 기반으로 HTTP/HTTPS 요청에 대한 허용/거부(403 Forbidden) 결정</p><li>Shield</li><ul><li>DDoS 보호 서비스</li><li>Shield Standard : 기본 제공</li><li>Shield Advanced : 고급 기능 제공(월 3,000 USD)</li></ul><li>Firewall Manager</li><p>조직의 계정과 애플리케이션 방화 규칙에 대한 중앙 관리 서비스</p></ul><h2>WAF</h2><ul><li>Web ACL : 액세스를 결정하는 규칙 리스트. 규칙은 ACL 제한 용량까지만 추가 가능</li><li>Rule : 각 규칙은 조건식을 가지며, 조건식을 만족하는 요청에 대해 허용/거부/카운트/CAPTCHA 중 어느 것을 실행할 지 결정한다</li><li>Rule group : 재사용 가능한 규칙</li></ul><div><h3>Rule</h3><div><h4 class="fake">Rule action</h4><ul><li>Allow : 요청 허용</li><p>요청에 커스텀 헤더 추가 가능</p><li>Count : 카운터 증가. 나머지 규칙 평가</li><p>요청에 커스텀 헤더 추가 가능. 이후 규칙 평가를 위한 커스텀 레이블 추가 가능</p><li>Block : 요청 거부</li><li>CAPTCHA : 캡차 실행</li></ul><h4 class="fake">Rule type</h4><ul><li>Regular rule : 조건 일치 요청에 대해 개별 action 결정</li><li>Rate-based rule : 기간(5분) 중 동일 IP에 대해 임계값 초과한 요청에 대해 action 결정</li></ul><h4 class="fake">Rule statement</h4><ul><li>모든 요청에 대해 action 실행</li><li>IP 기반 국가 코드 일치하는 요청에 대해 action 실행</li><li>IP 집합 포함 요청에 대해 action 실행</li><li>Label 소지 요청에 대해 action 실행</li><li>Header 패턴 일치 요청에 대해 action 실행</li><li>Query 패턴 일치 요청에 대해 action 실행</li><li>URI 패턴 일치 요청에 대해 action 실행</li><li>Body 패턴 일치 요청에 대해 action 실행</li><p>최대 8KB만 평가한다</p><li>HTTP method 패턴 일치 요청에 대해 action 실행</li></ul><p><strong>↓Rule 예시</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="json">{
    "Name": "RequestRate-by-IP",
    "Priority": 0,
    "Statement": {
        "RateBasedStatement": {
            "Limit": 1500,
            "AggregateKeyType": "IP"
        }
    },
    "Action": {
        "Block": {}
    },
    "VisibilityConfig": {
        "SampledRequestsEnabled": true,
        "CloudWatchMetricsEnabled": true,
        "MetricName": "RequestRate-by-IP"
    }
}
</div></div></div></div><h1>기타 서비스</h1><ul><li>AppConfig</li><p>애플리케이션 런타임 환경 배포 -- StartConfigurationSession로 세션을 수립한 클라이언트는 GetLatestConfiguration을 (주기적으로) 호출하여 구성을 가져온다</p><li>Chatbot</li><ul><li>SNS(Simple Notificatino Service)로부터 Amazon Chime 또는 Slack으로의 통지</li><li>Amazon Chime 또는 Slack에서 챗봇 IAM 역할로 명령 실행</li></ul><li>CloudTrail</li><p>보안 주체 활동 로깅<a class="w3-btn w3-round-xxlarge w3-small w3-green goto" href="#pos1453283971" target="_self">CloudTrail을 사용하여 이벤트 로깅</a></p><li>GuardDuty</li><p>계정 내의 비정상적인 활동을 식별하고, 활동의 보안 관련성을 분석하며, 호출된 컨텍스트를 제공</p><li>Network Firewall</li><p>VPC 경계 트랙픽 관리 방화. 보안 그룹만으로 불충분한 경우 사용</p><li>Resource Group</li><p>리소스 태그 또는 CloudFormation 스택 기반으로 리소스 그룹핑</p><li>Secrets Manager</li><p>암호 중앙 관리자. 암호 검색 API 제공</p><li>Security Hub</li><p>자동화된 보안 검사 -&gt; 우선순위가 높은 보안 문제 식별</p><li>EC2; Elastic Compute Cloud</li><p>OS를 포함한 컴퓨팅 머신</p><li>EBS; Elastic Block Store</li><p>EC2를 위한 스토리지(SSD)</p><li>EFS; Elastic File System</li><ul><li>용량 제약 없는 분산 네트워크 파일 시스템</li><li>동시에 수천 개의 인스턴스가 사용할 수 있다</li><li>EBS보다 지연시간은 느리지만, 단위 시간당 처리량은 높다</li><p>높은 IOPS에는 부적합</p></ul><li>Elastic Beanstalk</li><p>웹 앱 배포. Java, .NET, PHP, Node, Python, Ruby, Go, Docker...</p><li>S3; Simple Storage Service</li><p>99.999999999% 내구성. 크기 무제한</p><li>S3 Glacier</li><p>저렴한 데이터 아카이빙 S3 스토리지</p><li>ELB; Elastic Load Balancing</li><p>EC2 인스턴스, 컨테이너, IP 주소, Lambda 함수 등으로의 부하 분산</p><li>VPC; Virtual Private Cloud</li><p>사용자 정의 가상 네트워크</p><li>Auto Scaling</li><p>사용량에 따른 애플리케이션 규모 자동 조정</p><li>RDS; Relational Database Service</li><p>Amazon Aurora, PostgreSQL, MySQL, MariaDB, Oracle Database, SQL Server</p><li>Database Migration Service</li><p>기존 데이터베이스를 AWS RDS로 마이그레이션</p><li>ElastiCache</li><p>Redis, Memcached</p><li>CloudFront</li><p>글로벌 CDN</p><li>Route 53</li><p>엔드 유저의 요청을 적절한 EC2 인스턴스, ELB, S3 버킷 등으로 연결하는 DNS</p><li>Simple Queue Service</li><p>메시지 큐</p><li>Simple Notification Service</li><p>Pub/Sub 푸시 기반 메시징 서비스. 모바일 푸시, SMS, 이메일 등 가능</p><li>Simple Email Service</li><li>Organizations</li><ul><li>조직을 나누어 각 조직에 멤버 계정을 생성해 할당할 수 있다</li><li>각 조직에 대한 정책을 정의할 수 있다</li><li>단일 마스터 계정이 모든 비용을 지불한다</li></ul><li>CloudWatch</li><p>AWS 리소스 및 애플리케이션 모니터링</p></ul><h1>싱글 웹서버</h1><ol><li>규모가 작은 경우, API 게이트웨이 + 람다 조합이 더 저렴할 수 있다</li><li>EC2 인스턴스 생성</li><p>Auto-assign Public IP : Disable // 자동 할당되는 IP는 인스턴스가 시작할 때마다 변경된다<br>Shutdown behavior : Stop // Terminate는 OS 정지 후 EC2 인스턴스 삭제<br>Enable termination protection : 실수로 인스턴스 삭제되는 것을 방지</p><li>EC2 보안 그룹 설정</li><p>SSH | TCP | 22 | 작업 IP<br>HTTP | TCP | 80 | 0.0.0.0/0<br>HTTPS | TCP | 443 | 0.0.0.0/0</p><li>고정 퍼블릭 IP(EIP; Elastic IP) 부여</li><p>AWS 관리 콘솔에서 Allocate New Address → 우클릭 → Associate Address</p><li>도메인 연결 : Route 53</li><p>Create Record Set → Name : FQDN, Type : CNAME - Canon name, Value : EIP</p><li>EC2 인스턴스 삭제 시</li><p>Enable termination protection 해제 후 Terminate<br>연결된 EBS, EIP 삭제</p></ol><h1>VPC</h1><ol><div class="w3-center w3-margin-bottom"><img class="w3-round" src="/imgs/security-diagram.png"></div><li>AWS 계정 생성시 VPC, 서브넷, 라우팅 테이블, 인터넷 게이트웨이, 네트워크 ACL 등은 가용 리전 및 AZ에 대해 기본적으로 생성된다</li><p>NAT 게이트웨이 등 사용자가 필요에 의해 직접 추가하는 리소스들은 추가 요금이 발생함에 유의</p><li>VPC; Virtual Private Cloud</li><p>AWS 계정 및 AWS 리전에 대해 고유한 전용 네트워크</p><li>AZ; Availability Zone, 가용 영역</li><p>AWS 리전은 2개 이상의 가용 영역으로 구성되며, 각 AZ는 서로의 장애로부터 물리적으로 격리된다</p><li>Subnet</li><ul><li>VPC 내 할당 가능한 IP 주소 영역의 일부. AZ 안에 서브넷을 작성할 수 있으며, 다른 AZ와 공유되지 않는다</li><li>Private subnet 안에서 생성된 인스턴스에는 public IP가 부여되지 않는다</li><p>또는 인스턴스 실행 시 public IP 부여 여부를 결정할 수 있으며, 인터넷 게이트웨이와 연결되지 않은 라우팅 테이블에 서브넷을 연결하면 결과적으로 public IP가 없는 것과 같은 효과를 갖는다</p></ul><li>Route table</li><p>VPC 내부↔외부 네트워크 트래픽을 제어하는 규칙 정의. 라우팅 테이블 : 서브넷 = 1 : N 관계</p><li>Internet gateway</li><ul><li>VPC 내부와 외부 인터넷 사이의 연결 통로</li><li>VPC 내 인스턴스 → 외부 인터넷 : 트래픽의 송신 주소를 인스턴스의 public IP/Elastic IP로 설정</li><li>외부 인터넷 → VPC 내 인스턴스 : 트래픽의 수신 주소를 인스턴스의 private IP로 설정</li></ul><li>NAT gateway</li><ul><li>private 서브넷 내의 인스턴스가 외부 인터넷과 연결을 맺을 수 있도록 해준다</li><p>외부 인터넷이 먼저 연결을 시작할 수는 없다</p><li>VPC 내 인스턴스 → 외부 인터넷 : 트래픽의 송신 주소를 NAT의 Elastic IP로 설정</li><li>외부 인터넷 → VPC 내 인스턴스 : 트래픽의 수신 주소를 인스턴스의 private IP로 설정</li></ul><li>VPC endpoint</li><p>인터넷 게이트웨이를 거치지 않고, VPC 내 인스턴스와 AWS 서비스 또는 엔드포인트 서비스 사이의 직접적인 연결 지원</p><li>NIC; Network Interface Controller</li><p>서브넷 내에서, 특정 보안 그룹 집합을 갖는 NIC를 생성할 수 있다. 인스턴스 : NIC = 1 : N 관계이며, 결과적으로 인스턴스는 N개의 private IP 주소를 할당받는다</p><li>Network ACL; Network Access Control List</li><p>서브넷(들)에 대한 선택적인 방화벽 계층</p><table><caption>보안 그룹과 네트워크 ACL 비교</caption><tr><th>Security group</th><th>Network ACL</th></tr><tr><td>인스턴스 단위 동작</td><td>서브넷 단위 동작</td></tr><tr><td>허가 규칙만 존재</td><td>허가 + 거부 규칙 존재</td></tr><tr><td>Is stateful: 응답은 무조건 허가</td><td>Is stateless: 응답도 규칙에 의해 허가되어야 한다</td></tr><tr><td>규칙은 순서 없이 모두 평가</td><td>규칙은 우선순위에 의해 순차적으로 평가</td></tr><tr><td>적용된 인스턴스에 한해 적용</td><td>서브넷에 포함된 모든 인스턴스에 자동 적용(따라서 선택적인 보안 계층을 제공함을 의미)</td></tr></table><li>VPC peering connection</li><p>두 VPC(서로 다른 AWS 계정이어도 됨) 사이의 연결 지원. 인터넷 게이트웨이, VPN을 거치지 않고 각자의 private IP를 이용하여 AWS backbone을 통해 다이렉트로 암호화된 통신 가능</p><li>Client VPN</li><p>OpenVPN을 이용한 사용자 PC와 VPC 사이의 VPN 지원. private IP 주소를 이용한 인스턴스 접근이 가능해진다</p><li>Site-to-Site VPN</li><p>VPC와 사용자 네트워크 사이의 VPN 터널 유지</p><li>Traffic Mirroring</li><p>두 EC2 인스턴스 사이의 트래픽을 미러링할 수 있다. ALB도 AWS 관리 EC2 인스턴스이므로, EC2 - ALB 사이의 트래픽도 확인할 수 있다.<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://sjakthol.github.io/posts/alb-vpc-traffic-mirroring/">참고 자료</a></p></ol><h1>서버 다중화</h1><ol><li>ELB 설정</li><p>ELB는 엔드 유저의 요청을 받아야 하므로 0.0.0.0/0 소스 허용<br>EC2 인스턴스 등은 ELB를 거친 연결만 허용하도록 보안 그룹 소스 변경<br>ELB의 로드밸런서 프로토콜을 HTTPS, 인스턴스의 프로토콜을 HTTP로 하면 ELB가 SSL 처리를 모두 담당</p><li>RDS의 DB 다중화(Master-Standby)</li><p>관리 콘솔 → RDS 설정 → DB 서브넷 그룹 작성 : 두 AZ 각각에 작성한 서브넷을 그루핑<br>RDS 인스턴스 생성 시 멀티-AZ 옵션으로 DB 서브넷 그룹 지정<br>RDS는 강제 업그레이드가 실행될 수 있으며, 멀티-AZ를 이용하는 경우, 스탠바이 서버부터 업그레이드되어 새로운 마스터가 된다</p></ol><h1>EC2</h1><div><h2>Amazon Linux 2 이미지</h2><div><h3>CodeDeploy agent 설치</h3><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">$ sudo yum install ruby -y
$ sudo yum install wget -y

# 리전에 따라 아래 url은 달라짐
$ wget https://aws-codedeploy-ap-northeast-2.s3.amazonaws.com/latest/install
$ chmod +x ./install
$ sudo ./install auto
$ sudo service codedeploy-agent status
</div><h3>JDK(corretto) 설치</h3><p><strong>↓shell</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="shell">$ sudo rpm --import https://yum.corretto.aws/corretto.key
$ sudo curl -L -o /etc/yum.repos.d/corretto.repo https://yum.corretto.aws/corretto.repo
$ sudo yum install -y java-17-amazon-corretto-devel
</div><h3>aws configure</h3><p>인스턴스 내에서 aws cli 명령을 실행하려는 경우, 미리 자격 증명을 설정하는 것이 편리하다</p><h3>시작 템플릿 > 사용자 데이터에서 CodeDeploy 실행</h3><p><strong>↓bash</strong></p><div class="as-code code-div w3-leftbar w3-border-green" lan="bash">#!/bin/bash
aws deploy create-deployment --application-name AppName --deployment-config-name CodeDeployDefault.OneAtATime --deployment-group-name GroupName --s3-location bucket=BucketName,bundleType=zip,key=ObjectKey
</div></div></div><h1>CloudFront</h1><div><h2>캐시 정책 TTL 관련</h2><ul><li>캐시 정책의 min, max, default TTL을 모두 31536000으로 설정해도 제대로 적용되지 않는 것으로 확인된다(2022-01-06)</li><li>객체 속성 &gt; 메타데이터에서 Cache-Control값을 "public, max-age=31536000"으로 설정하는 것이 적용률이 높다</li><p>그럼에도 불구하고 - 캐시 무효화를 3번이나 반복했음에도 - 모든 파일에 대해 캐시 관련 헤더가 제대로 설정되진 않았다(2022-01-06)</p></ul><h2>로드 밸런서를 원본으로 사용하는 경우 고려사항</h2><ul><li>GET 요청(캐시 대상)이 아닌 경우 성능이 나빠진다</li><p>지리적으로 가장 가까운 엣지 포인트를 통해 AWS의 백본 네트워크를 이용하여 통신하므로 빨라질 것이라 기대해봤지만, 그렇지 않았다.</p><ul><li>테스트(2021-11-26) 조건 : 요청지@서울, 서버@us-east-2</li><li>로드밸런서를 통해 직접 통신한 경우 190-200ms로 균일한 응답시간 확인</li><li>CDN을 거친 경우, 일부 요청은 10% 정도 빨리 응답(175ms 내외)되었지만, 절반 정도는 2배 이상 소요(670ms 내외)되었다.</li></ul><li>각 응답 캐시 시간을 Cache-Control: max-age 헤더로 조정<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://aws.amazon.com/ko/premiumsupport/knowledge-center/cloudfront-cache-files-time/">cloudfront-cache-files-time</a></li><li>쿼리 스트링 캐시 정책 조정<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://docs.aws.amazon.com/ko_kr/AmazonCloudFront/latest/DeveloperGuide/QueryStringParameters.html">QueryStringParameters</a></li></ul></div><h1>Lambda</h1><div><h2>Lambda@Edge</h2><ul><li>CloudFront 요청/응답으로 트리거되는 람다 함수</li><p>원본 이미지 1개에 대하여, 여러 사이즈의 캐시 응답을 생성하는 예시 :<a class="w3-btn w3-round-xxlarge w3-small w3-green" href="https://aws.amazon.com/ko/blogs/networking-and-content-delivery/resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog/">resizing-images-with-amazon-cloudfront-lambdaedge-aws-cdn-blog</a></p><li>Lambda Layer는 지원되지 않는다</li></ul><div><h3 class="fake">가능한 실행 지점</h3><ol><li>Viewer Request : CloudFront가 요청을 받아, 캐시를 검사하는 시점에 실행</li><li>Origin Request : 캐시에 항목이 없어 원본(origin)을 요청하는 시점에 실행</li><li>Origin Response : 원본(origin) 응답을 받은 이후, 캐시에 적재하기 전에 실행</li><li>Viewer Response : 응답을 엔드 유저에게 전달하기 전에 실행</li></ol></div></div><h1>특이 현상</h1><div><h2>CPU 사용률이 100을 초과하는 현상(2022-01-21)</h2><p>EC2 및 ElastiCache(Redis)에서 발생하였으며, 이 때문에 Auto Scaling 그룹의 자동 조정 정책 지표를 인스턴스 평균 CPU 사용률 대신 평균 ALB 요청 수로 변경함</p><div class="w3-center w3-margin-bottom"><img class="w3-round" src="/imgs/photo_2022-02-10 16.08.44.jpeg" title="EC2 스크린샷" alt="EC2 스크린샷"><br><strong>&lt;EC2 스크린샷></strong></div><div class="w3-center w3-margin-bottom"><img class="w3-round" src="/imgs/photo_2022-02-10 16.16.52.jpeg" title="Redis 스크린샷" alt="Redis 스크린샷"><br><strong>&lt;Redis 스크린샷></strong></div><h2>WAF 규칙 적용 후 평균 응답 시간(P95, P99 포함 전부)이 획기적으로 단축된 것으로 보고되는 현상(2022-01-16)</h2><p>ALB 통계에 포함되는 처리 시간 일부가 WAF 규칙 평가로 옮겨가서?</p><div class="w3-center w3-margin-bottom"><img class="w3-round" src="/imgs/photo_2022-02-10 16.21.20.jpeg"></div></div></div></article><hr></body></html>